---
import { eq } from "drizzle-orm";

import { getAuth } from "@/auth";
import { Badge } from "@/components/ui/badge";
import { getRequestDb } from "@/db/request";
import { authUsers, categories, contracts, countries, resumes } from "@/db/schema";
import PublicLayout from "@/layouts/PublicLayout.astro";
import { formatDescriptionHtml } from "@/lib/description";
import { resolveCandidateImage } from "@/lib/image-fallback";
import { resolveNormalizedUserRoleFromRecord } from "@/services/users/role-adapter";

export const prerender = false;

const idRaw = (Astro.params.id ?? "").trim();
const parsedId = Number.parseInt(idRaw, 10);
const invalidId = !Number.isFinite(parsedId) || parsedId <= 0;

const session = await getAuth(Astro.locals).api.getSession({
  headers: Astro.request.headers,
});
if (!session?.session?.id || !session.user) {
  return Astro.redirect(`/auth/login?next=${encodeURIComponent(Astro.url.pathname)}`, 302);
}

const db = getRequestDb(Astro.locals);
const rows = invalidId
  ? []
  : await db
      .select()
      .from(resumes)
      .leftJoin(authUsers, eq(resumes.userId, authUsers.id))
      .leftJoin(categories, eq(resumes.categoryId, categories.id))
      .leftJoin(countries, eq(resumes.countryId, countries.id))
      .leftJoin(contracts, eq(resumes.contractCode, contracts.code))
      .where(eq(resumes.id, parsedId))
      .limit(1);

const notFound = rows.length === 0;
if (notFound) {
  Astro.response.status = 404;
}

const viewerRole = resolveNormalizedUserRoleFromRecord(session.user);
const isOwner = !notFound && rows[0].resumes.userId === Number(session.user.id);
if (viewerRole === "candidate" && !isOwner) {
  return Astro.redirect("/errors/403", 302);
}

const resume = rows[0]?.resumes ?? null;
const user = rows[0]?.auth_users ?? null;
const category = rows[0]?.categories ?? null;
const country = rows[0]?.countries ?? null;
const contract = rows[0]?.contracts ?? null;

function formatSalary(min: number | null, currency: string | null, period: string | null): string | null {
  const hasMin = (min ?? 0) > 0;
  if (!hasMin) return null;

  const formatter = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const amount = formatter.format(min ?? 0);
  const suffix = currency && period ? ` ${currency} / ${period}` : "";
  return `${amount}${suffix}`;
}

function relativeDate(dateValue: Date | string | null): string {
  if (!dateValue) return "Recently";
  const date = dateValue instanceof Date ? dateValue : new Date(dateValue);
  if (Number.isNaN(date.getTime())) return "Recently";

  const deltaSeconds = Math.round((date.getTime() - Date.now()) / 1000);
  const abs = Math.abs(deltaSeconds);
  const rtf = new Intl.RelativeTimeFormat("en", { numeric: "auto" });

  if (abs < 60) return rtf.format(Math.round(deltaSeconds), "second");
  if (abs < 3600) return rtf.format(Math.round(deltaSeconds / 60), "minute");
  if (abs < 86400) return rtf.format(Math.round(deltaSeconds / 3600), "hour");
  if (abs < 604800) return rtf.format(Math.round(deltaSeconds / 86400), "day");
  return rtf.format(Math.round(deltaSeconds / 604800), "week");
}

const salary = resume ? formatSalary(resume.salaryMin, resume.currency, resume.salaryPeriod) : null;
const skills = ((resume?.skills ?? ""))
  .split(",")
  .map((value) => value.trim())
  .filter(Boolean);
const candidateName = (user?.candidateName ?? "").trim();
const candidateEmail = (user?.email ?? "").trim();
const candidatePhone = (user?.candidatePhone ?? "").trim();
const candidateImage = resolveCandidateImage(user?.image ?? "");
const categoryTitle = category?.title ?? "Uncategorized";
const countryName = country?.name ?? "Unspecified";
---

<PublicLayout
  title={notFound ? "Resume not found" : `${resume?.position ?? "Resume"} (${resume?.id ?? parsedId})`}
  description={notFound ? "Resume not found." : `${resume?.position ?? "Resume"} resume in ${categoryTitle}.`}
  canonicalPath={Astro.url.pathname}
  robots="noindex,nofollow"
  noAds
  jsonLd={{
    "@context": "https://schema.org",
    "@type": "ProfilePage",
    name: notFound ? "Resume not found" : `${resume?.position ?? "Resume"} (${resume?.id ?? parsedId})`,
    description: notFound ? "Resume not found." : `${resume?.position ?? "Resume"} resume in ${categoryTitle}.`,
  }}
>
  {
    notFound ? (
      <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
        <h1 class="text-4xl font-semibold tracking-tight">Resume not found</h1>
        <p class="mt-3 text-sm text-red-700">Resume not found. Please use candidate search to find available profiles.</p>
        <a class="mt-4 inline-flex rounded-full border px-4 py-2 text-sm font-medium hover:bg-secondary" href="/resumes">Candidates Search</a>
      </section>
    ) : (
      <>
        <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
          <nav class="mb-4 text-sm text-muted-foreground">
            <a class="hover:underline" href="/resumes">Candidates Search</a>
            <span class="mx-2">-&gt;</span>
            <span>{resume?.position}</span>
          </nav>

          <div class="flex flex-wrap items-start gap-4">
            <img
              src={candidateImage}
              alt=""
              class="h-20 w-20 rounded-full border object-cover"
              loading="lazy"
            />
            <div class="min-w-[260px] flex-1">
              <h1 class="text-4xl font-semibold tracking-tight">{resume?.position}</h1>
              {candidateName ? <p class="mt-2 text-sm text-muted-foreground">{candidateName}</p> : null}
              <div class="mt-3 flex flex-wrap gap-2 text-xs">
                <Badge className="bg-emerald-100 text-emerald-900 hover:bg-emerald-100">
                  {contract?.title ?? "Contract not specified"}
                </Badge>
                {salary ? <Badge className="bg-sky-100 text-sky-900 hover:bg-sky-100">{salary}</Badge> : null}
              </div>
            </div>
          </div>

          <div class="mt-5 flex flex-wrap gap-2 text-xs">
            <Badge className="bg-amber-100 text-amber-900 hover:bg-amber-100">
              Posted: {relativeDate(resume?.updatedAt ?? null)}
            </Badge>
            <Badge className="bg-slate-200 text-slate-900 hover:bg-slate-200">{categoryTitle}</Badge>
            <Badge className="bg-teal-100 text-teal-900 hover:bg-teal-100">{countryName}</Badge>
          </div>

          <article class="prose prose-sm mt-5 max-w-none" set:html={formatDescriptionHtml(resume?.description ?? "")} />

          {
            skills.length > 0 ? (
              <div class="mt-4 flex flex-wrap gap-2">
                {skills.map((skill) => <span class="rounded-full bg-secondary px-3 py-1 text-xs font-medium">{skill}</span>)}
              </div>
            ) : null
          }
        </section>

        <section class="glass-panel mt-4 rounded-3xl border p-6 shadow-sm md:p-8">
          <h2 class="text-2xl font-semibold tracking-tight">Resume contact data</h2>
          {candidateName ? <p class="mt-3 text-sm"><strong>Name:</strong> {candidateName}</p> : null}
          {candidateEmail ? (
            <p class="mt-2 text-sm">
              <strong>Email:</strong> <a class="text-blue-600 underline" href={`mailto:${candidateEmail}`}>{candidateEmail}</a>
            </p>
          ) : null}
          {candidatePhone ? <p class="mt-2 text-sm"><strong>Phone:</strong> {candidatePhone}</p> : null}
          <a class="mt-5 inline-flex rounded-full bg-emerald-800 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-900" href="/app/jobs/create">
            Post a job
          </a>
        </section>
      </>
    )
  }
</PublicLayout>
