---
import { and, desc, eq, sql } from "drizzle-orm";

import { getAuth } from "@/auth";
import { Badge } from "@/components/ui/badge";
import { getRequestDb } from "@/db/request";
import { authUsers, categories, contracts, countries, resumes } from "@/db/schema";
import PublicLayout from "@/layouts/PublicLayout.astro";
import { buildPaginationState } from "@/lib/pagination";
import { toAbsoluteUrl } from "@/lib/seo";
import { resolveNormalizedUserRoleFromRecord } from "@/services/users/role-adapter";

export const prerender = false;

const session = await getAuth(Astro.locals).api.getSession({
  headers: Astro.request.headers,
});
if (!session?.session?.id || !session.user) {
  return Astro.redirect(`/auth/login?next=${encodeURIComponent(`/resumes/search${Astro.url.search}`)}`, 302);
}

const viewerRole = resolveNormalizedUserRoleFromRecord(session.user);
if (viewerRole === "candidate") {
  return Astro.redirect("/errors/403", 302);
}

const db = getRequestDb(Astro.locals);

const position = (Astro.url.searchParams.get("position") ?? Astro.url.searchParams.get("q") ?? "").trim();
const categoryParam = (Astro.url.searchParams.get("category_id") ?? "").trim();
const countryParam = (Astro.url.searchParams.get("country_id") ?? "").trim();
const pagination = buildPaginationState(Astro.url.searchParams.get("page"), 20);

const parsedCategoryId = Number.parseInt(categoryParam, 10);
const categoryId = Number.isFinite(parsedCategoryId) && parsedCategoryId > 0 ? parsedCategoryId : null;

const parsedCountryId = Number.parseInt(countryParam, 10);
const countryId = Number.isFinite(parsedCountryId) && parsedCountryId > 0 ? parsedCountryId : null;

const whereClauses = [eq(resumes.status, 1)];
if (position) {
  whereClauses.push(sql`lower(${resumes.position}) like ${`%${position.toLowerCase()}%`}`);
}
if (categoryId !== null) {
  whereClauses.push(eq(resumes.categoryId, categoryId));
}
if (countryId !== null) {
  whereClauses.push(eq(resumes.countryId, countryId));
}

const resultRows = await db
  .select()
  .from(resumes)
  .leftJoin(authUsers, eq(resumes.userId, authUsers.id))
  .leftJoin(categories, eq(resumes.categoryId, categories.id))
  .leftJoin(countries, eq(resumes.countryId, countries.id))
  .leftJoin(contracts, eq(resumes.contractCode, contracts.code))
  .where(and(...whereClauses))
  .orderBy(desc(resumes.id))
  .limit(pagination.pageSize + 1)
  .offset(pagination.offset);

const hasNext = resultRows.length > pagination.pageSize;
const allMatchingRows = await db.select().from(resumes).where(and(...whereClauses));
const totalResults = allMatchingRows.length;

const items = resultRows.slice(0, pagination.pageSize).map((row) => ({
  id: row.resumes.id,
  position: row.resumes.position,
  description: row.resumes.description,
  skills: row.resumes.skills,
  updatedAt: row.resumes.updatedAt,
  salaryMin: row.resumes.salaryMin,
  currency: row.resumes.currency,
  salaryPeriod: row.resumes.salaryPeriod,
  categoryTitle: row.categories?.title ?? null,
  countryName: row.countries?.name ?? null,
  contractTitle: row.contracts?.title ?? null,
  candidateName: row.auth_users?.candidateName ?? "",
  candidatePhoto: row.auth_users?.candidatePhoto ?? "",
}));

if (pagination.page > 1 && items.length === 0) {
  throw new Response("Not found", { status: 404 });
}

const prevPage = pagination.page > 1 ? pagination.page - 1 : null;
const nextPage = hasNext ? pagination.page + 1 : null;
const noAds = items.length === 0;

function buildPageHref(page: number): string {
  const url = new URL("/resumes/search", Astro.url);
  if (position) {
    url.searchParams.set("position", position);
  }
  if (categoryId !== null) {
    url.searchParams.set("category_id", String(categoryId));
  }
  if (countryId !== null) {
    url.searchParams.set("country_id", String(countryId));
  }
  if (page > 1) {
    url.searchParams.set("page", String(page));
  }
  return `${url.pathname}${url.search}`;
}

const canonicalPath = buildPageHref(pagination.page);
const heading = pagination.page > 1 ? `Resume Search Results - Page ${pagination.page}` : "Resume Search Results";
const pageTitle = pagination.page > 1 ? `Resume Search - Page ${pagination.page}` : "Resume Search";
const resultSummary = totalResults > 0
  ? `Results ${pagination.offset + 1}-${pagination.offset + items.length} of ${totalResults}`
  : "No resumes found";

function plainText(input: string | null): string {
  if (!input) return "";
  return input.replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
}

function excerpt(input: string | null, maxWords = 40): string {
  const words = plainText(input).split(/\s+/).filter(Boolean);
  if (words.length <= maxWords) return words.join(" ");
  return `${words.slice(0, maxWords).join(" ")}...`;
}

function formatSalary(min: number | null, currency: string | null, period: string | null): string {
  const hasMin = (min ?? 0) > 0;
  if (!hasMin) return "";

  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
  const amount = formatter.format(min ?? 0);
  const unit = currency && period ? ` ${currency} / ${period}` : "";
  return `${amount}${unit}`;
}

function relativeDate(dateValue: Date | string | null): string {
  if (!dateValue) return "Recently";
  const date = dateValue instanceof Date ? dateValue : new Date(dateValue);
  if (Number.isNaN(date.getTime())) return "Recently";

  const deltaSeconds = Math.round((date.getTime() - Date.now()) / 1000);
  const abs = Math.abs(deltaSeconds);
  const rtf = new Intl.RelativeTimeFormat("en", { numeric: "auto" });

  if (abs < 60) return rtf.format(Math.round(deltaSeconds), "second");
  if (abs < 3600) return rtf.format(Math.round(deltaSeconds / 60), "minute");
  if (abs < 86400) return rtf.format(Math.round(deltaSeconds / 3600), "hour");
  if (abs < 604800) return rtf.format(Math.round(deltaSeconds / 86400), "day");
  return rtf.format(Math.round(deltaSeconds / 604800), "week");
}
---

<PublicLayout
  title={pageTitle}
  description="Browse candidate resumes by position, category, and country."
  canonicalPath={canonicalPath}
  robots="noindex,nofollow"
  prevPath={prevPage ? buildPageHref(prevPage) : undefined}
  nextPath={nextPage ? buildPageHref(nextPage) : undefined}
  noAds={noAds}
  jsonLd={{
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "CollectionPage",
        name: heading,
        url: toAbsoluteUrl(canonicalPath),
        description: "Candidate resume search results.",
      },
      {
        "@type": "BreadcrumbList",
        itemListElement: [
          { "@type": "ListItem", position: 1, name: "Home", item: toAbsoluteUrl("/") },
          { "@type": "ListItem", position: 2, name: "Candidate Search", item: toAbsoluteUrl("/resumes") },
          { "@type": "ListItem", position: 3, name: "Search Results", item: toAbsoluteUrl("/resumes/search") },
        ],
      },
    ],
  }}
>
  <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
    <h1 class="text-4xl font-semibold tracking-tight">{heading}</h1>
    <p class="mt-3 text-sm text-muted-foreground">{resultSummary}</p>
  </section>

  {
    items.length === 0 ? (
      <section class="mt-4">
        <article class="glass-panel rounded-2xl border p-5">
          <h2 class="text-2xl font-semibold tracking-tight">No matching resumes found</h2>
          <p class="mt-2 text-sm text-muted-foreground">Try broader keywords or remove category/country filters.</p>
        </article>
      </section>
    ) : (
      <section class="mt-4 space-y-4">
        {
          items.map((resume) => {
            const salary = formatSalary(resume.salaryMin, resume.currency, resume.salaryPeriod);
            const skillList = resume.skills
              ? resume.skills.split(",").map((skill) => skill.trim()).filter(Boolean).slice(0, 8)
              : [];

            return (
              <article class="glass-panel rounded-2xl border p-5 shadow-sm">
                <div class="flex flex-wrap items-start justify-between gap-3">
                  <div class="flex items-start gap-3">
                    {
                      resume.candidatePhoto ? (
                        <img
                          src={resume.candidatePhoto}
                          alt=""
                          loading="lazy"
                          class="size-14 rounded-full border object-cover"
                        />
                      ) : null
                    }
                    <div>
                      <a class="block text-2xl font-semibold tracking-tight hover:underline" href={`/resumes/${resume.id}`}>
                        {resume.position}
                      </a>
                      {
                        resume.candidateName ? (
                          <p class="mt-1 text-sm text-muted-foreground">{resume.candidateName}</p>
                        ) : null
                      }
                      {
                        resume.contractTitle ? (
                          <Badge className="mt-2 bg-emerald-100 text-emerald-900 hover:bg-emerald-100">
                            {resume.contractTitle}
                          </Badge>
                        ) : null
                      }
                    </div>
                  </div>
                  {
                    salary ? (
                      <Badge className="bg-sky-100 text-sky-900 hover:bg-sky-100">
                        {salary}
                      </Badge>
                    ) : null
                  }
                </div>

                <p class="mt-4 text-sm text-muted-foreground">{excerpt(resume.description)}</p>

                {
                  skillList.length > 0 ? (
                    <div class="mt-4 flex flex-wrap gap-2">
                      {skillList.map((skill) => <span class="rounded-full bg-secondary px-3 py-1 text-xs font-medium">{skill}</span>)}
                    </div>
                  ) : null
                }

                <div class="mt-5 flex flex-wrap gap-2 text-xs">
                  <Badge className="bg-amber-100 text-amber-900 hover:bg-amber-100">
                    Posted: {relativeDate(resume.updatedAt)}
                  </Badge>
                  {
                    resume.categoryTitle ? (
                      <Badge className="bg-slate-200 text-slate-900 hover:bg-slate-200">{resume.categoryTitle}</Badge>
                    ) : null
                  }
                  {
                    resume.countryName ? (
                      <Badge className="bg-teal-100 text-teal-900 hover:bg-teal-100">{resume.countryName}</Badge>
                    ) : null
                  }
                </div>
              </article>
            );
          })
        }
      </section>
    )
  }

  {
    nextPage ? (
      <nav class="mt-6 flex items-center gap-3 text-sm">
        {
          prevPage
            ? <a class="rounded-full border px-4 py-2 hover:bg-secondary" href={buildPageHref(prevPage)}>Previous</a>
            : <span class="rounded-full border px-4 py-2 text-muted-foreground">Previous</span>
        }
        <a class="rounded-full border px-4 py-2 hover:bg-secondary" href={buildPageHref(nextPage)}>Next</a>
      </nav>
    ) : null
  }
</PublicLayout>
