---
import { asc } from "drizzle-orm";

import { getAuth } from "@/auth";
import { getRequestDb } from "@/db/request";
import { categories, countries } from "@/db/schema";
import PublicLayout from "@/layouts/PublicLayout.astro";
import { socialImages } from "@/lib/social-images";
import { resolveNormalizedUserRoleFromRecord } from "@/services/users/role-adapter";

export const prerender = false;

const session = await getAuth(Astro.locals).api.getSession({
  headers: Astro.request.headers,
});
if (!session?.session?.id || !session.user) {
  return Astro.redirect("/login?next=/resumes", 302);
}

const viewerRole = resolveNormalizedUserRoleFromRecord(session.user);
if (viewerRole === "candidate") {
  return Astro.redirect("/403", 302);
}

const db = getRequestDb(Astro.locals);

const categoryRows = await db.select().from(categories).orderBy(asc(categories.title));
const countryRows = await db.select().from(countries).orderBy(asc(countries.weight), asc(countries.name));
---

<PublicLayout
  title="Candidate Search"
  description="Search candidate resumes by position, category, and country."
  canonicalPath="/resumes"
  socialImagePath={socialImages.resumes}
  robots="noindex,nofollow"
  noAds={true}
>
  <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
    <h1 class="text-4xl font-semibold tracking-tight">Candidates Search</h1>
    <p class="mt-3 max-w-3xl text-sm text-muted-foreground md:text-base">
      Find candidate resumes by position, category, and location.
    </p>

    <form class="mt-6 grid gap-3 md:grid-cols-[1fr_220px_220px_auto]" action="/resumes/search" method="GET">
      <label class="sr-only" for="position">Resume position</label>
      <input
        id="position"
        name="position"
        type="text"
        placeholder="Position, skill, or keyword"
        autocomplete="off"
        class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
      />

      <div class="relative">
        <label class="sr-only" for="category_id">Category</label>
        <select
          id="category_id"
          name="category_id"
          class="h-11 w-full appearance-none rounded-xl border bg-background px-3 pr-9 text-sm"
        >
          <option value="">Select category</option>
          {
            categoryRows.map((row) => (
              <option value={String(row.id)}>{row.title}</option>
            ))
          }
        </select>
        <span class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-muted-foreground">▾</span>
      </div>

      <div class="relative">
        <label class="sr-only" for="country_id">Candidate country</label>
        <select
          id="country_id"
          name="country_id"
          class="h-11 w-full appearance-none rounded-xl border bg-background px-3 pr-9 text-sm"
        >
          <option value="">Select country</option>
          {
            countryRows.map((row) => (
              <option value={String(row.id)}>{row.name}</option>
            ))
          }
        </select>
        <span class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-muted-foreground">▾</span>
      </div>

      <button
        type="submit"
        class="h-11 rounded-xl bg-primary px-5 text-sm font-semibold text-primary-foreground hover:opacity-90"
      >
        Search
      </button>
    </form>
  </section>
</PublicLayout>
