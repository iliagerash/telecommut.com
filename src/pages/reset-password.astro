---
import PublicLayout from "@/layouts/PublicLayout.astro";
import { socialImages } from "@/lib/social-images";

const token = (Astro.url.searchParams.get("token") ?? "").trim();
const error = (Astro.url.searchParams.get("error") ?? "").trim();
---

<PublicLayout
  title="Set New Password"
  description="Set a new password for your Telecommut account."
  robots="noindex,nofollow"
  socialImagePath={socialImages.home}
>
  <section class="glass-panel mx-auto w-full max-w-xl rounded-3xl border p-6 shadow-sm md:p-8">
    <h1 class="mt-3 text-4xl font-semibold tracking-tight">Set new password</h1>
    <p class="mt-3 text-muted-foreground">
      Choose a strong password with at least 8 characters.
    </p>

    {error ? (
      <div class="mt-5 rounded-xl border border-red-400/40 bg-red-500/10 p-3 text-sm text-red-900">
        Reset link is invalid or expired. Please request a new one.
      </div>
    ) : null}

    <form id="reset-password-form" class="mt-6 space-y-3">
      <input id="reset-token" type="hidden" value={token} />
      <div>
        <label class="sr-only" for="new-password">New password</label>
        <input
          id="new-password"
          name="newPassword"
          type="password"
          required
          minlength="8"
          placeholder="New password *"
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          autocomplete="new-password"
        />
      </div>
      <div>
        <label class="sr-only" for="confirm-password">Confirm password</label>
        <input
          id="confirm-password"
          name="confirmPassword"
          type="password"
          required
          minlength="8"
          placeholder="Confirm password *"
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          autocomplete="new-password"
        />
      </div>
      <div class="flex items-center gap-3">
        <button
          id="reset-password-submit"
          type="submit"
          class="rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground hover:opacity-90"
        >
          Reset password
        </button>
        <p id="reset-password-status" class="text-sm text-muted-foreground" role="status" aria-live="polite"></p>
      </div>
    </form>

    <div class="mt-6 flex flex-wrap gap-3 text-sm">
      <a class="rounded-full border px-4 py-2 font-semibold hover:bg-secondary" href="/password/reset">
        Request new link
      </a>
      <a class="rounded-full border px-4 py-2 font-semibold hover:bg-secondary" href="/login">
        Back to login
      </a>
    </div>
  </section>

  <script is:inline>
    const form = document.getElementById("reset-password-form");
    const statusEl = document.getElementById("reset-password-status");
    const submit = document.getElementById("reset-password-submit");
    const tokenInput = document.getElementById("reset-token");

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!statusEl || !submit || !tokenInput || !(form instanceof HTMLFormElement)) return;

      const token = tokenInput instanceof HTMLInputElement ? tokenInput.value.trim() : "";
      const formData = new FormData(form);
      const newPassword = String(formData.get("newPassword") ?? "");
      const confirmPassword = String(formData.get("confirmPassword") ?? "");

      if (!token) {
        statusEl.textContent = "Missing reset token. Please request a new reset link.";
        return;
      }
      if (newPassword.length < 8) {
        statusEl.textContent = "Password must be at least 8 characters.";
        return;
      }
      if (newPassword !== confirmPassword) {
        statusEl.textContent = "Passwords do not match.";
        return;
      }

      submit.setAttribute("disabled", "disabled");
      statusEl.textContent = "Updating password...";

      try {
        const response = await fetch("/api/auth/reset-password", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ token, newPassword }),
        });
        const json = await response.json().catch(() => null);
        if (!response.ok) {
          const message = typeof json?.message === "string" ? json.message : "Unable to reset password.";
          statusEl.textContent = message;
          return;
        }

        statusEl.textContent = "Password reset complete. Redirecting to login...";
        window.setTimeout(() => {
          window.location.href = "/login";
        }, 900);
      } catch {
        statusEl.textContent = "Unable to complete request. Please try again.";
      } finally {
        submit.removeAttribute("disabled");
      }
    });
  </script>
</PublicLayout>
