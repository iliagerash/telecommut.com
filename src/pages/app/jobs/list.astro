---
import { and, desc, eq } from "drizzle-orm";

import { getAuth } from "@/auth";
import { Badge } from "@/components/ui/badge";
import { getRequestDb } from "@/db/request";
import { categories, jobs } from "@/db/schema";
import PublicLayout from "@/layouts/PublicLayout.astro";
import { buildPaginationState } from "@/lib/pagination";
import { resolveNormalizedUserRoleFromRecord } from "@/services/users/role-adapter";

export const prerender = false;

const session = await getAuth(Astro.locals).api.getSession({
  headers: Astro.request.headers,
});
if (!session?.session?.id || !session.user?.id) {
  return Astro.redirect(`/login?next=${encodeURIComponent(`/app/jobs/list${Astro.url.search}`)}`, 302);
}

const viewerRole = resolveNormalizedUserRoleFromRecord(session.user);
if (viewerRole === "candidate") {
  return Astro.redirect("/403", 302);
}

const pagination = buildPaginationState(Astro.url.searchParams.get("page"), 20);
const db = getRequestDb(Astro.locals);
const rows = await db
  .select()
  .from(jobs)
  .leftJoin(categories, eq(jobs.categoryId, categories.id))
  .where(and(eq(jobs.userId, String(session.user.id))))
  .orderBy(desc(jobs.updatedAt), desc(jobs.id))
  .limit(pagination.pageSize + 1)
  .offset(pagination.offset);

const hasNext = rows.length > pagination.pageSize;
const items = rows.slice(0, pagination.pageSize);
if (pagination.page > 1 && items.length === 0) {
  throw new Response("Not found", { status: 404 });
}

const prevPage = pagination.page > 1 ? pagination.page - 1 : null;
const nextPage = hasNext ? pagination.page + 1 : null;

function buildPageHref(page: number): string {
  const url = new URL("/app/jobs/list", Astro.url);
  if (page > 1) {
    url.searchParams.set("page", String(page));
  }
  return `${url.pathname}${url.search}`;
}

function plainText(input: string | null): string {
  if (!input) return "";
  return input.replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
}

function excerpt(input: string | null, maxWords = 40): string {
  const words = plainText(input).split(/\s+/).filter(Boolean);
  if (words.length <= maxWords) return words.join(" ");
  return `${words.slice(0, maxWords).join(" ")}...`;
}

function formatSalary(min: number | null, max: number | null, currency: string | null, period: string | null): string {
  const hasMin = (min ?? 0) > 0;
  const hasMax = (max ?? 0) > 0;
  if (!hasMin && !hasMax) return "";

  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
  const parts: string[] = [];
  if (hasMin) parts.push(formatter.format(min ?? 0));
  if (hasMax) {
    if (parts.length > 0) parts.push("-");
    parts.push(formatter.format(max ?? 0));
  }

  const unit = currency && period ? ` ${currency} / ${period}` : "";
  return `${parts.join(" ")}${unit}`;
}

function relativeDate(dateValue: string | null): string {
  if (!dateValue) return "Recently";
  const date = new Date(dateValue);
  if (Number.isNaN(date.getTime())) return "Recently";

  const deltaSeconds = Math.round((date.getTime() - Date.now()) / 1000);
  const abs = Math.abs(deltaSeconds);
  const rtf = new Intl.RelativeTimeFormat("en", { numeric: "auto" });

  if (abs < 60) return rtf.format(Math.round(deltaSeconds), "second");
  if (abs < 3600) return rtf.format(Math.round(deltaSeconds / 60), "minute");
  if (abs < 86400) return rtf.format(Math.round(deltaSeconds / 3600), "hour");
  if (abs < 604800) return rtf.format(Math.round(deltaSeconds / 86400), "day");
  return rtf.format(Math.round(deltaSeconds / 604800), "week");
}

const successText = (Astro.url.searchParams.get("success") ?? "").trim();
const errorText = (Astro.url.searchParams.get("error") ?? "").trim();
const returnTo = `${Astro.url.pathname}${Astro.url.search}`;
---

<PublicLayout title="My Jobs" description="Manage your posted jobs." robots="noindex,nofollow" noAds={true}>
  <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h1 class="text-3xl font-semibold tracking-tight">My Jobs</h1>
      <a class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground hover:opacity-90" href="/app/jobs/create">
        Post a job
      </a>
    </div>

    {
      successText ? <p class="mt-4 rounded-xl border border-emerald-300 bg-emerald-50 px-3 py-2 text-sm text-emerald-700">{successText}</p> : null
    }
    {
      errorText ? <p class="mt-4 rounded-xl border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700">{errorText}</p> : null
    }

    {
      items.length === 0 ? (
        <p class="mt-6 text-sm text-muted-foreground">No jobs yet.</p>
      ) : (
        <div class="mt-6 space-y-4">
          {
            items.map((row) => {
              const salaryText = formatSalary(row.jobs.salaryMin, row.jobs.salaryMax, row.jobs.currency, row.jobs.salaryPeriod);
              return (
                <article class="rounded-2xl border bg-background p-4">
                  <div class="flex flex-wrap items-start justify-between gap-3">
                    <div>
                      <h2 class="text-2xl font-semibold tracking-tight">
                        <a class="hover:underline" href={`/jobs/${row.jobs.id}`} target="_blank" rel="noreferrer">
                          {row.jobs.position}
                        </a>
                      </h2>
                      <p class="mt-1 text-sm text-muted-foreground">
                        {row.jobs.companyName || "Unknown company"}
                        {row.categories?.title ? ` - ${row.categories.title.trim()}` : ""}
                        {`, ${relativeDate(row.jobs.updatedAt)}`}
                      </p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                      {row.jobs.status ? <Badge className="bg-primary text-primary-foreground">Approved</Badge> : <Badge>Pending approval</Badge>}
                      {
                        salaryText ? (
                          <Badge className="bg-emerald-100 text-emerald-900 hover:bg-emerald-100">{salaryText}</Badge>
                        ) : null
                      }
                    </div>
                  </div>

                  <p class="mt-3 text-sm text-muted-foreground">{excerpt(row.jobs.description)}</p>

                  <div class="mt-4 flex flex-wrap items-center gap-2">
                    <a class="rounded-xl border px-3 py-1.5 text-sm hover:bg-secondary" href={`/app/jobs/edit/${row.jobs.id}`}>Edit</a>
                    <form action="/api/jobs/renew" method="POST">
                      <input type="hidden" name="job_id" value={String(row.jobs.id)} />
                      <input type="hidden" name="return_to" value={returnTo} />
                      <button type="submit" class="rounded-xl border border-emerald-500 px-3 py-1.5 text-sm text-emerald-700 hover:bg-emerald-50">
                        Renew
                      </button>
                    </form>
                    <form action="/api/jobs/delete" method="POST" onsubmit="return window.confirm('Please confirm job deletion');">
                      <input type="hidden" name="job_id" value={String(row.jobs.id)} />
                      <input type="hidden" name="return_to" value={returnTo} />
                      <button type="submit" class="rounded-xl border border-red-500 px-3 py-1.5 text-sm text-red-700 hover:bg-red-50">
                        Delete
                      </button>
                    </form>
                  </div>
                </article>
              );
            })
          }
        </div>
      )
    }

    {
      prevPage || nextPage ? (
        <nav class="mt-6 flex items-center gap-3 text-sm">
          {
            prevPage
              ? <a class="rounded-full border px-4 py-2 hover:bg-secondary" href={buildPageHref(prevPage)}>Previous</a>
              : <span class="rounded-full border px-4 py-2 text-muted-foreground">Previous</span>
          }
          {
            nextPage
              ? <a class="rounded-full border px-4 py-2 hover:bg-secondary" href={buildPageHref(nextPage)}>Next</a>
              : <span class="rounded-full border px-4 py-2 text-muted-foreground">Next</span>
          }
        </nav>
      ) : null
    }
  </section>
</PublicLayout>
