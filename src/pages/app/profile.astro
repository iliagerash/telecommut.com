---
import { eq } from "drizzle-orm";

import { getAuth } from "@/auth";
import { Input } from "@/components/ui/input";
import { getRequestDb } from "@/db/request";
import { authUsers, jobs, resumes } from "@/db/schema";
import PublicLayout from "@/layouts/PublicLayout.astro";

export const prerender = false;

const session = await getAuth(Astro.locals).api.getSession({
  headers: Astro.request.headers,
});

if (!session?.session?.id || !session.user) {
  return Astro.redirect("/auth/login?next=/app/profile", 302);
}

const user = session.user;
const db = getRequestDb(Astro.locals);
const sessionUserId = Number(user.id);
const [profileUser] = await db.select().from(authUsers).where(eq(authUsers.id, sessionUserId)).limit(1);
const storedRoleRaw = String(profileUser?.role ?? user.role ?? "candidate").trim().toLowerCase();
const storedRole = storedRoleRaw === "admin" || storedRoleRaw === "employer" || storedRoleRaw === "candidate"
  ? storedRoleRaw
  : "candidate";
const editableRole = storedRole === "employer" ? "employer" : "candidate";
const [existingJob, existingResume] = await Promise.all([
  db.select().from(jobs).where(eq(jobs.userId, sessionUserId)).limit(1),
  db.select().from(resumes).where(eq(resumes.userId, sessionUserId)).limit(1),
]);
const canChangeRole = storedRole === "candidate"
  ? existingResume.length === 0
  : storedRole === "employer"
    ? existingJob.length === 0
    : false;
const currentImage = (profileUser?.image ?? "").trim();
const hasProfileImage = currentImage.length > 0;
const profileFieldRole = canChangeRole ? editableRole : storedRole;
---

<PublicLayout robots="noindex,nofollow" title="Profile" description="Manage your account details and password.">
  <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
    <h2 class="text-3xl font-semibold tracking-tight">My Profile</h2>
    <p class="mt-2 text-sm text-muted-foreground">Update your account details and credentials.</p>

    <section class="mt-6 space-y-3 rounded-2xl border bg-background p-4">
      <h3 class="text-lg font-semibold">Profile image</h3>
      <img
        id="profile-image-preview"
        src={currentImage || ""}
        alt="Profile image"
        class:list={[
          "h-28 w-28 rounded-xl border object-cover",
          !currentImage && "hidden",
        ]}
      />
      <div class="space-y-2">
        <label class="text-sm font-medium" for="profile-image-file">Upload image</label>
        <Input id="profile-image-file" type="file" accept="image/png,image/jpeg,image/gif,image/webp" />
      </div>
      <div class="flex items-center gap-3">
        <button
          id="profile-image-upload-submit"
          type="button"
          class="rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground hover:opacity-90"
        >
          Upload image
        </button>
        <button
          id="profile-image-delete-submit"
          type="button"
          class:list={[
            "rounded-xl border px-5 py-2.5 text-sm font-semibold hover:bg-secondary",
            !currentImage && "hidden",
          ]}
        >
          Delete image
        </button>
        <p id="profile-image-status" class="text-sm text-muted-foreground" role="status" aria-live="polite"></p>
      </div>
      <p class="text-xs text-muted-foreground">Accepted formats: PNG, JPG, GIF, WebP. Max size: 2 MB.</p>
    </section>

    <form
      id="profile-data-form"
      class="mt-6 space-y-3"
      data-role={profileFieldRole}
      data-current-role={storedRole}
    >
      <h3 class="text-lg font-semibold">My data</h3>
      <div class="grid gap-1 text-sm text-muted-foreground">
        <p>Email: <span class="font-medium text-foreground">{user.email}</span></p>
        <p>User role: <span id="profile-current-role" class="font-medium text-foreground">{storedRole}</span></p>
      </div>

      {canChangeRole ? (
        <>
          <div id="role-select-wrap" class:list={[hasProfileImage && "hidden"]}>
            <label class="mb-1 block text-sm font-medium" for="role-select">User role</label>
            <select
              id="role-select"
              name="role"
              class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
            >
              <option value="candidate" selected={editableRole === "candidate"}>candidate</option>
              <option value="employer" selected={editableRole === "employer"}>employer</option>
            </select>
          </div>
          <p id="role-change-image-note" class:list={["text-xs text-muted-foreground", !hasProfileImage && "hidden"]}>
            Remove your profile image before changing role.
          </p>
        </>
      ) : (
        <input type="hidden" name="role" value={storedRole} />
      )}

      <div id="candidate-fields" class:list={[profileFieldRole !== "candidate" && "hidden"]}>
        <div>
          <label class="sr-only" for="candidate-name">Name</label>
          <input
            id="candidate-name"
            name="candidateName"
            type="text"
            value={profileUser?.candidateName ?? ""}
            placeholder="Name *"
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
            autocomplete="name"
          />
        </div>
        <div class="mt-3">
          <label class="sr-only" for="candidate-phone">Phone</label>
          <input
            id="candidate-phone"
            name="candidatePhone"
            type="text"
            value={profileUser?.candidatePhone ?? ""}
            placeholder="Phone"
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
            autocomplete="tel"
          />
        </div>
      </div>

      <div id="employer-fields" class:list={[profileFieldRole !== "employer" && "hidden"]}>
        <div>
          <label class="sr-only" for="company-name">Company name</label>
          <input
            id="company-name"
            name="companyName"
            type="text"
            value={profileUser?.companyName ?? ""}
            placeholder="Company name *"
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
            autocomplete="organization"
          />
        </div>
        <div class="mt-3">
          <label class="sr-only" for="company-phone">Phone</label>
          <input
            id="company-phone"
            name="companyPhone"
            type="text"
            value={profileUser?.companyPhone ?? ""}
            placeholder="Phone"
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
            autocomplete="tel"
          />
        </div>
        <div class="mt-3">
          <label class="sr-only" for="company-contact">Contact person</label>
          <input
            id="company-contact"
            name="companyContact"
            type="text"
            value={profileUser?.companyContact ?? ""}
            placeholder="Contact person"
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
            autocomplete="name"
          />
        </div>
        <div class="mt-3">
          <label class="sr-only" for="company-description">Company description</label>
          <textarea
            id="company-description"
            name="companyDescription"
            rows="6"
            placeholder="Company description"
            class="w-full rounded-xl border bg-background px-3 py-2 text-sm"
          >{profileUser?.companyDescription ?? ""}</textarea>
        </div>
      </div>

      <div class="rounded-xl border bg-background px-4 py-3">
        <p class="text-sm font-semibold">Email subscriptions</p>
        <label class="mt-2 flex items-start gap-2 text-sm">
          <input id="subscribe" name="subscribe" type="checkbox" class="mt-1" checked={Boolean(profileUser?.subscribe)} />
          <span>I agree to receive emails from this website</span>
        </label>
        <label class="mt-2 flex items-start gap-2 text-sm">
          <input
            id="subscribe-partners"
            name="subscribePartners"
            type="checkbox"
            class="mt-1"
            checked={Boolean(profileUser?.subscribePartners)}
          />
          <span>I agree to receive emails from this website&apos;s partners</span>
        </label>
      </div>

      <div class="flex items-center gap-3">
        <button
          id="profile-data-submit"
          type="submit"
          class="rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground hover:opacity-90"
        >
          Update data
        </button>
        <p id="profile-data-status" class="text-sm text-muted-foreground" role="status" aria-live="polite"></p>
      </div>
    </form>

    <form id="profile-password-form" class="mt-8 space-y-3">
      <h3 class="text-lg font-semibold">Change password</h3>
      <div>
        <label class="sr-only" for="current-password">Current password</label>
        <input
          id="current-password"
          name="currentPassword"
          type="password"
          required
          placeholder="Current password *"
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          autocomplete="current-password"
        />
      </div>
      <div>
        <label class="sr-only" for="new-password">Password</label>
        <input
          id="new-password"
          name="newPassword"
          type="password"
          required
          minlength="8"
          placeholder="Password *"
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          autocomplete="new-password"
        />
      </div>
      <div>
        <label class="sr-only" for="new-password-confirm">Confirm password</label>
        <input
          id="new-password-confirm"
          name="newPasswordConfirm"
          type="password"
          required
          minlength="8"
          placeholder="Confirm password *"
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          autocomplete="new-password"
        />
      </div>
      <div class="flex items-center gap-3">
        <button
          id="profile-password-submit"
          type="submit"
          class="rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground hover:opacity-90"
        >
          Update password
        </button>
        <p id="profile-password-status" class="text-sm text-muted-foreground" role="status" aria-live="polite"></p>
      </div>
    </form>

    <form id="profile-delete-form" class="mt-10 rounded-2xl border border-red-300 bg-red-50/50 p-4">
      <h3 class="text-lg font-semibold text-red-700">Delete my account</h3>
      <p class="mt-2 text-sm text-red-700">
        Attention: all information associated with your profile, including jobs or resumes, will be deleted.
      </p>
      <div class="mt-3 flex items-center gap-3">
        <button
          id="profile-delete-submit"
          type="submit"
          class="rounded-xl bg-red-600 px-5 py-2.5 text-sm font-semibold text-white hover:opacity-90"
        >
          Delete
        </button>
        <p id="profile-delete-status" class="text-sm text-muted-foreground" role="status" aria-live="polite"></p>
      </div>
    </form>
  </section>
  <script is:inline>
    const imageUploadInput = document.getElementById("profile-image-file");
    const imageUploadSubmit = document.getElementById("profile-image-upload-submit");
    const imageDeleteSubmit = document.getElementById("profile-image-delete-submit");
    const imageStatus = document.getElementById("profile-image-status");
    const imagePreview = document.getElementById("profile-image-preview");
    let serverImageUrl =
      imagePreview instanceof HTMLImageElement ? String(imagePreview.getAttribute("src") ?? "").trim() : "";
    let hasPendingLocalPreview = false;

    function setStatus(element, message, kind = "info") {
      if (!(element instanceof HTMLElement)) return;
      element.textContent = message;
      element.classList.remove("text-muted-foreground", "text-red-600", "text-emerald-700");
      if (kind === "error") element.classList.add("text-red-600");
      else if (kind === "success") element.classList.add("text-emerald-700");
      else element.classList.add("text-muted-foreground");
    }

    function setInputError(input) {
      if (!(input instanceof HTMLInputElement) && !(input instanceof HTMLTextAreaElement)) return;
      input.classList.add("border-red-500", "ring-2", "ring-red-300");
    }

    function clearInputError(input) {
      if (!(input instanceof HTMLInputElement) && !(input instanceof HTMLTextAreaElement)) return;
      input.classList.remove("border-red-500", "ring-2", "ring-red-300");
    }

    imageUploadSubmit?.addEventListener("click", async () => {
      if (!(imageUploadInput instanceof HTMLInputElement) || !imageStatus || !imageUploadSubmit) return;

      const file = imageUploadInput.files?.[0];
      if (!file) {
        setStatus(imageStatus, "Select an image file first.", "error");
        return;
      }

      imageUploadSubmit.setAttribute("disabled", "disabled");
      setStatus(imageStatus, "Uploading image...");

      const payload = new FormData();
      payload.set("image", file);

      try {
        const response = await fetch("/api/profile/upload-image", {
          method: "POST",
          body: payload,
        });
        const json = await response.json().catch(() => null);
        if (!response.ok) {
          const message = typeof json?.message === "string" ? json.message : "Unable to upload image.";
          setStatus(imageStatus, message, "error");
          return;
        }

        if (imagePreview instanceof HTMLImageElement && typeof json?.imageUrl === "string" && json.imageUrl.length > 0) {
          imagePreview.src = json.imageUrl;
          imagePreview.classList.remove("hidden");
          serverImageUrl = json.imageUrl;
          hasPendingLocalPreview = false;
        }
        if (imageDeleteSubmit instanceof HTMLElement) {
          imageDeleteSubmit.classList.remove("hidden");
        }
        if (roleSelectWrap instanceof HTMLElement) {
          roleSelectWrap.classList.add("hidden");
        }
        if (roleChangeImageNote instanceof HTMLElement) {
          roleChangeImageNote.classList.remove("hidden");
        }
        imageUploadInput.value = "";
        setStatus(imageStatus, "Image uploaded.", "success");
      } catch {
        setStatus(imageStatus, "Unable to complete request. Please try again.", "error");
      } finally {
        imageUploadSubmit.removeAttribute("disabled");
      }
    });

    imageUploadInput?.addEventListener("change", () => {
      if (!(imageUploadInput instanceof HTMLInputElement)) return;
      const file = imageUploadInput.files?.[0];
      if (!file) return;

      if (imagePreview instanceof HTMLImageElement) {
        imagePreview.src = URL.createObjectURL(file);
        imagePreview.classList.remove("hidden");
      }
      hasPendingLocalPreview = true;
      if (imageDeleteSubmit instanceof HTMLElement) {
        imageDeleteSubmit.classList.remove("hidden");
      }
      if (imageStatus instanceof HTMLElement) {
        setStatus(imageStatus, "Preview ready. Click Upload image to save.", "info");
      }
    });

    imageDeleteSubmit?.addEventListener("click", async () => {
      if (!imageDeleteSubmit || !imageStatus) return;

      if (hasPendingLocalPreview) {
        if (imageUploadInput instanceof HTMLInputElement) {
          imageUploadInput.value = "";
        }
        hasPendingLocalPreview = false;

        if (imagePreview instanceof HTMLImageElement) {
          if (serverImageUrl) {
            imagePreview.src = serverImageUrl;
            imagePreview.classList.remove("hidden");
          } else {
            imagePreview.src = "";
            imagePreview.classList.add("hidden");
          }
        }
        if (imageDeleteSubmit instanceof HTMLElement && !serverImageUrl) {
          imageDeleteSubmit.classList.add("hidden");
        }
        if (!serverImageUrl) {
          if (roleSelectWrap instanceof HTMLElement) {
            roleSelectWrap.classList.remove("hidden");
          }
          if (roleChangeImageNote instanceof HTMLElement) {
            roleChangeImageNote.classList.add("hidden");
          }
        }
        setStatus(imageStatus, "Selected image removed.", "info");
        return;
      }

      imageDeleteSubmit.setAttribute("disabled", "disabled");
      setStatus(imageStatus, "Deleting image...");

      try {
        const response = await fetch("/api/profile/delete-image", {
          method: "POST",
          headers: { "content-type": "application/json" },
        });
        const json = await response.json().catch(() => null);
        if (!response.ok) {
          const message = typeof json?.message === "string" ? json.message : "Unable to delete image.";
          setStatus(imageStatus, message, "error");
          return;
        }

        if (imagePreview instanceof HTMLImageElement) {
          imagePreview.src = "";
          imagePreview.classList.add("hidden");
        }
        serverImageUrl = "";
        if (imageDeleteSubmit instanceof HTMLElement) {
          imageDeleteSubmit.classList.add("hidden");
        }
        if (roleSelectWrap instanceof HTMLElement) {
          roleSelectWrap.classList.remove("hidden");
        }
        if (roleChangeImageNote instanceof HTMLElement) {
          roleChangeImageNote.classList.add("hidden");
        }
        setStatus(imageStatus, "Image deleted.", "success");
      } catch {
        setStatus(imageStatus, "Unable to complete request. Please try again.", "error");
      } finally {
        imageDeleteSubmit.removeAttribute("disabled");
      }
    });

    const dataForm = document.getElementById("profile-data-form");
    const dataSubmit = document.getElementById("profile-data-submit");
    const dataStatus = document.getElementById("profile-data-status");
    const currentRoleLabel = document.getElementById("profile-current-role");
    const roleSelectWrap = document.getElementById("role-select-wrap");
    const roleChangeImageNote = document.getElementById("role-change-image-note");
    const roleSelect = document.getElementById("role-select");
    const candidateFields = document.getElementById("candidate-fields");
    const employerFields = document.getElementById("employer-fields");
    const candidateNameInput = document.getElementById("candidate-name");
    const companyNameInput = document.getElementById("company-name");

    function updateRoleFieldVisibility(nextRole) {
      if (candidateFields instanceof HTMLElement) {
        candidateFields.classList.toggle("hidden", nextRole !== "candidate");
      }
      if (employerFields instanceof HTMLElement) {
        employerFields.classList.toggle("hidden", nextRole !== "employer");
      }
    }

    if (roleSelect instanceof HTMLSelectElement) {
      roleSelect.addEventListener("change", () => {
        updateRoleFieldVisibility(roleSelect.value);
      });
      updateRoleFieldVisibility(roleSelect.value);
    } else if (dataForm instanceof HTMLFormElement) {
      updateRoleFieldVisibility(String(dataForm.dataset.role ?? "candidate"));
    }

    dataForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!dataSubmit || !dataStatus || !(dataForm instanceof HTMLFormElement)) return;

      clearInputError(candidateNameInput);
      clearInputError(companyNameInput);

      const formData = new FormData(dataForm);
      const role = String(formData.get("role") ?? dataForm.dataset.role ?? "candidate").toLowerCase();
      const candidateName = String(formData.get("candidateName") ?? "").trim();
      const candidatePhone = String(formData.get("candidatePhone") ?? "").trim();
      const companyName = String(formData.get("companyName") ?? "").trim();
      const companyPhone = String(formData.get("companyPhone") ?? "").trim();
      const companyContact = String(formData.get("companyContact") ?? "").trim();
      const companyDescription = String(formData.get("companyDescription") ?? "").trim();
      const subscribe = formData.has("subscribe");
      const subscribePartners = formData.has("subscribePartners");

      if (role === "candidate" && candidateName.length === 0) {
        setInputError(candidateNameInput);
        setStatus(dataStatus, "Name is required.", "error");
        return;
      }

      if (role === "employer" && companyName.length === 0) {
        setInputError(companyNameInput);
        setStatus(dataStatus, "Company name is required.", "error");
        return;
      }

      dataSubmit.setAttribute("disabled", "disabled");
      setStatus(dataStatus, "Updating...");

      try {
        const response = await fetch("/api/profile/update", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            role,
            candidateName,
            candidatePhone,
            companyName,
            companyPhone,
            companyContact,
            companyDescription,
            subscribe,
            subscribePartners,
          }),
        });
        const json = await response.json().catch(() => null);
        if (!response.ok) {
          const message = typeof json?.message === "string" ? json.message : "Unable to update profile data.";
          setStatus(dataStatus, message, "error");
          return;
        }
        const nextRole = role === "employer" ? "employer" : "candidate";
        setStatus(dataStatus, "Profile data updated.", "success");
        const currentRole = String(dataForm.dataset.currentRole ?? "candidate").toLowerCase();
        dataForm.dataset.currentRole = nextRole;
        if (currentRoleLabel instanceof HTMLElement) {
          currentRoleLabel.textContent = nextRole;
        }
        if (nextRole !== currentRole) {
          window.location.reload();
        }
      } catch {
        setStatus(dataStatus, "Unable to complete request. Please try again.", "error");
      } finally {
        dataSubmit.removeAttribute("disabled");
      }
    });

    const passwordForm = document.getElementById("profile-password-form");
    const passwordSubmit = document.getElementById("profile-password-submit");
    const passwordStatus = document.getElementById("profile-password-status");
    const currentPasswordInput = document.getElementById("current-password");
    const newPasswordInput = document.getElementById("new-password");
    const newPasswordConfirmInput = document.getElementById("new-password-confirm");

    passwordForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!passwordSubmit || !passwordStatus || !(passwordForm instanceof HTMLFormElement)) return;

      clearInputError(currentPasswordInput);
      clearInputError(newPasswordInput);
      clearInputError(newPasswordConfirmInput);

      const formData = new FormData(passwordForm);
      const currentPassword = String(formData.get("currentPassword") ?? "");
      const newPassword = String(formData.get("newPassword") ?? "");
      const newPasswordConfirm = String(formData.get("newPasswordConfirm") ?? "");

      if (newPassword.length < 8) {
        setInputError(newPasswordInput);
        setStatus(passwordStatus, "Password must be at least 8 characters.", "error");
        return;
      }
      if (newPassword !== newPasswordConfirm) {
        setInputError(newPasswordInput);
        setInputError(newPasswordConfirmInput);
        setStatus(passwordStatus, "Passwords do not match.", "error");
        return;
      }

      passwordSubmit.setAttribute("disabled", "disabled");
      setStatus(passwordStatus, "Updating password...");

      try {
        const response = await fetch("/api/auth/change-password", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            currentPassword,
            newPassword,
            revokeOtherSessions: false,
          }),
        });
        const json = await response.json().catch(() => null);
        if (!response.ok) {
          const message = typeof json?.message === "string" ? json.message : "Unable to update password.";
          setInputError(currentPasswordInput);
          setInputError(newPasswordInput);
          setInputError(newPasswordConfirmInput);
          setStatus(passwordStatus, message, "error");
          return;
        }
        setStatus(passwordStatus, "Password updated.", "success");
        passwordForm.reset();
      } catch {
        setStatus(passwordStatus, "Unable to complete request. Please try again.", "error");
      } finally {
        passwordSubmit.removeAttribute("disabled");
      }
    });

    const deleteForm = document.getElementById("profile-delete-form");
    const deleteSubmit = document.getElementById("profile-delete-submit");
    const deleteStatus = document.getElementById("profile-delete-status");

    deleteForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!deleteSubmit || !deleteStatus) return;

      const confirmed = window.confirm(
        "Please confirm account deletion. All information associated with your profile, including jobs or resumes, will be deleted.",
      );
      if (!confirmed) return;

      deleteSubmit.setAttribute("disabled", "disabled");
      setStatus(deleteStatus, "Deleting account...");

      try {
        const response = await fetch("/api/profile/delete", {
          method: "POST",
          headers: { "content-type": "application/json" },
        });
        const json = await response.json().catch(() => null);
        if (!response.ok) {
          const message = typeof json?.message === "string" ? json.message : "Unable to delete account.";
          setStatus(deleteStatus, message, "error");
          return;
        }
        window.location.href = "/";
      } catch {
        setStatus(deleteStatus, "Unable to complete request. Please try again.", "error");
      } finally {
        deleteSubmit.removeAttribute("disabled");
      }
    });
  </script>
</PublicLayout>
