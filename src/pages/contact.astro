---
import PublicLayout from "@/layouts/PublicLayout.astro";
import { toAbsoluteUrl } from "@/lib/seo";

const contactJsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "BreadcrumbList",
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          name: "Home",
          item: toAbsoluteUrl("/"),
        },
        {
          "@type": "ListItem",
          position: 2,
          name: "Contact",
          item: toAbsoluteUrl("/contact"),
        },
      ],
    },
    {
      "@type": "WebPage",
      name: "Contact",
      url: toAbsoluteUrl("/contact"),
      description: "Contact us",
      inLanguage: "en",
    },
  ],
};
---

<PublicLayout
  title="Contact"
  description="Contact us"
  keywords="Contact"
  canonicalPath="/contact"
  robots="noindex,nofollow"
  noAds
  jsonLd={contactJsonLd}
>
  <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
    <h1 class="text-4xl font-semibold tracking-tight">Contacts</h1>
    <p class="mt-3 max-w-2xl text-muted-foreground">Please use this form to contact us.</p>
  </section>

  <section class="mt-4">
    <div class="glass-panel rounded-2xl border p-5 shadow-sm md:p-6">
      <form id="contact-form" class="space-y-3">
        <div>
          <label class="sr-only" for="contact-name">Your name</label>
          <input
            id="contact-name"
            name="name"
            type="text"
            required
            placeholder="Your name *"
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          />
        </div>
        <div>
          <label class="sr-only" for="contact-email">Your email</label>
          <input
            id="contact-email"
            name="email"
            type="email"
            required
            placeholder="Your email *"
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          />
        </div>
        <div>
          <label class="sr-only" for="contact-message">Your message</label>
          <textarea
            id="contact-message"
            name="message"
            required
            placeholder="Your message *"
            class="min-h-40 w-full rounded-xl border bg-background px-3 py-2 text-sm"
          ></textarea>
        </div>
        <div class="hidden" aria-hidden="true">
          <label for="contact-website">Website</label>
          <input id="contact-website" name="website" type="text" autocomplete="off" tabindex="-1" />
        </div>
        <div class="flex items-center gap-3">
          <button
            id="contact-submit"
            type="submit"
            class="rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground hover:opacity-90"
          >
            Send message
          </button>
          <p id="contact-status" class="text-sm text-muted-foreground" role="status" aria-live="polite"></p>
        </div>
      </form>
      <div id="contact-success" class="hidden space-y-3" role="status" aria-live="polite">
        <h2 class="text-2xl font-semibold tracking-tight">Message sent</h2>
        <p class="text-sm text-muted-foreground">
          Thank you for contacting Telecommut. Your message has been received and routed to our support inbox.
        </p>
        <p class="text-sm text-muted-foreground">We usually respond as soon as possible.</p>
      </div>
    </div>
  </section>

  <script is:inline>
    const form = document.getElementById("contact-form");
    const successPanel = document.getElementById("contact-success");
    const status = document.getElementById("contact-status");
    const submit = document.getElementById("contact-submit");
    const nameInput = document.getElementById("contact-name");
    const emailInput = document.getElementById("contact-email");
    const messageInput = document.getElementById("contact-message");

    function clearInputError(input) {
      if (!(input instanceof HTMLInputElement) && !(input instanceof HTMLTextAreaElement)) return;
      input.classList.remove("border-red-500", "ring-2", "ring-red-300");
    }

    function setInputError(input) {
      if (!(input instanceof HTMLInputElement) && !(input instanceof HTMLTextAreaElement)) return;
      input.classList.add("border-red-500", "ring-2", "ring-red-300");
    }

    function setStatus(message, kind = "info") {
      if (!(status instanceof HTMLElement)) return;
      status.textContent = message;
      status.classList.remove("text-muted-foreground", "text-red-600", "text-emerald-700");
      if (kind === "error") status.classList.add("text-red-600");
      else if (kind === "success") status.classList.add("text-emerald-700");
      else status.classList.add("text-muted-foreground");
    }

    if (form && successPanel && status && submit) {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        clearInputError(nameInput);
        clearInputError(emailInput);
        clearInputError(messageInput);

        const formData = new FormData(form);
        const payload = {
          name: String(formData.get("name") ?? "").trim(),
          email: String(formData.get("email") ?? "").trim(),
          message: String(formData.get("message") ?? "").trim(),
          website: String(formData.get("website") ?? ""),
        };

        if (!payload.name) {
          setInputError(nameInput);
          setStatus("Name is required.", "error");
          return;
        }
        if (!payload.email) {
          setInputError(emailInput);
          setStatus("Email is required.", "error");
          return;
        }
        if (!payload.message) {
          setInputError(messageInput);
          setStatus("Message is required.", "error");
          return;
        }

        submit.setAttribute("disabled", "disabled");
        submit.setAttribute("aria-busy", "true");
        setStatus("Sending...");

        try {
          const response = await fetch("/api/contact", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (response.ok) {
            form.reset();
            form.classList.add("hidden");
            successPanel.classList.remove("hidden");
            return;
          }

          if (response.status === 429) {
            setStatus("Too many requests. Please try again later.", "error");
            return;
          }

          if (response.status === 400) {
            setInputError(nameInput);
            setInputError(emailInput);
            setInputError(messageInput);
            setStatus("Unable to send message. Check your input and try again.", "error");
            return;
          }

          if (response.status === 503) {
            setStatus("Contact service is unavailable right now. Please try again later.", "error");
            return;
          }

          setStatus("Unable to send message right now. Please try again later.", "error");
        } catch {
          setStatus("Unable to send message right now. Please try again later.", "error");
        } finally {
          submit.removeAttribute("disabled");
          submit.removeAttribute("aria-busy");
        }
      });
    }
  </script>
</PublicLayout>
