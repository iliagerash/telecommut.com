---
import { desc, eq } from "drizzle-orm";

import { getRequestDb } from "@/db/request";
import { categories, contracts, countries, countryGroups, jobs } from "@/db/schema";
import PublicLayout from "@/layouts/PublicLayout.astro";
import { toAbsoluteUrl } from "@/lib/seo";
import AdMiddle from "@/components/ads/AdMiddle.astro";
import AdTop from "@/components/ads/AdTop.astro";
import { Badge } from "@/components/ui/badge";
import HomeSearchForm from "@/components/home/HomeSearchForm";
import CategoryIcon from "@/components/home/CategoryIcon";
import { resolveEmployerImage } from "@/lib/image-fallback";

export const prerender = false;

const db = getRequestDb(Astro.locals);

const query = (Astro.url.searchParams.get("position") ?? "").trim();
const category = (Astro.url.searchParams.get("category") ?? "").trim();

const recentJobRows = await db
  .select()
  .from(jobs)
  .leftJoin(categories, eq(jobs.categoryId, categories.id))
  .leftJoin(countries, eq(jobs.countryId, countries.id))
  .leftJoin(contracts, eq(jobs.contractCode, contracts.code))
  .where(eq(jobs.status, 1))
  .orderBy(desc(jobs.id))
  .limit(12);

const categoryTableRows = await db.select().from(categories).orderBy(categories.title);
const activeJobRows = await db.select().from(jobs).where(eq(jobs.status, 1));
const countryGroupRows = await db.select().from(countryGroups);

const categoryCountById = new Map<number, number>();
for (const row of activeJobRows) {
  categoryCountById.set(row.categoryId, (categoryCountById.get(row.categoryId) ?? 0) + 1);
}

const recentJobs = recentJobRows.map((row) => ({
  id: row.jobs.id,
  userId: row.jobs.userId,
  position: row.jobs.position,
  companyName: row.jobs.companyName,
  companyLogo: row.jobs.companyLogo,
  salaryMin: row.jobs.salaryMin,
  salaryMax: row.jobs.salaryMax,
  currency: row.jobs.currency,
  salaryPeriod: row.jobs.salaryPeriod,
  description: row.jobs.description,
  skills: row.jobs.skills,
  updatedAt: row.jobs.updatedAt,
  countryGroups: row.jobs.countryGroups,
  categoryTitle: row.categories?.title ?? null,
  countryName: row.countries?.name ?? null,
  contractTitle: row.contracts?.title ?? null,
}));

const categoryRows = categoryTableRows.map((row) => ({
  id: row.id,
  title: row.title,
  slug: row.slug,
  icon: row.icon,
  description: row.description,
  jobsCount: categoryCountById.get(row.id) ?? 0,
}));

const categoryOptions = categoryRows.map((row) => ({
  id: row.id,
  title: row.title,
  slug: row.slug,
}));

function categoryPathSegment(input: { slug: string | null }): string | null {
  const value = input.slug?.trim();
  return value ? encodeURIComponent(value) : null;
}

const activeJobsCount = activeJobRows.length;
const countryGroupNameById = new Map(countryGroupRows.map((row) => [String(row.id), row.name]));

function plainText(input: string | null): string {
  if (!input) return "";
  return input.replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
}

function excerpt(input: string | null, max = 360): string {
  const text = plainText(input);
  if (text.length <= max) return text;
  return `${text.slice(0, max).trimEnd()}...`;
}

function formatSalary(min: number | null, max: number | null, currency: string | null, period: string | null): string {
  const hasMin = (min ?? 0) > 0;
  const hasMax = (max ?? 0) > 0;
  if (!hasMin && !hasMax) return "Salary not specified";

  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
  const parts = [];
  if (hasMin) parts.push(formatter.format(min ?? 0));
  if (hasMax) {
    if (parts.length > 0) {
      parts.push("-");
    }
    parts.push(formatter.format(max ?? 0));
  }

  const unit = currency && period ? ` ${currency} / ${period}` : "";
  return `${parts.join(" ")}${unit}`;
}

function relativeDate(dateValue: Date | string | null): string {
  if (!dateValue) return "Recently";
  const date = dateValue instanceof Date ? dateValue : new Date(dateValue);
  if (Number.isNaN(date.getTime())) return "Recently";

  const deltaSeconds = Math.round((date.getTime() - Date.now()) / 1000);
  const abs = Math.abs(deltaSeconds);
  const rtf = new Intl.RelativeTimeFormat("en", { numeric: "auto" });

  if (abs < 60) return rtf.format(Math.round(deltaSeconds), "second");
  if (abs < 3600) return rtf.format(Math.round(deltaSeconds / 60), "minute");
  if (abs < 86400) return rtf.format(Math.round(deltaSeconds / 3600), "hour");
  if (abs < 604800) return rtf.format(Math.round(deltaSeconds / 86400), "day");
  return rtf.format(Math.round(deltaSeconds / 604800), "week");
}

function resolveHiringFrom(countryGroupsValue: string | null, countryName: string | null): string {
  const normalized = (countryGroupsValue ?? "").trim();
  if (!normalized || normalized === "0") {
    return countryName?.trim() || "Worldwide";
  }

  const keys = normalized
    .split(",")
    .map((value) => value.trim())
    .filter(Boolean)
    .filter((value) => value !== "0");

  if (keys.length === 0) {
    return countryName?.trim() || "Worldwide";
  }

  const labels = keys
    .map((key) => countryGroupNameById.get(key))
    .filter((value): value is string => Boolean(value));

  if (labels.length === 0) {
    return countryName?.trim() || "Worldwide";
  }

  return labels.join(", ");
}

const jobsCountLabel = new Intl.NumberFormat("en-US").format(activeJobsCount);
const categoriesCountLabel = new Intl.NumberFormat("en-US").format(categoryRows.length);
const homepageDescription = `Find verified remote jobs across engineering, design, product, support, and marketing. Search ${jobsCountLabel} active listings and apply directly on Telecommut.`;
const seoIntro = `${jobsCountLabel} active remote jobs in ${categoriesCountLabel} categories. Fresh listings are added and moderated daily.`;
const homepageJsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      name: "Telecommut",
      url: toAbsoluteUrl("/"),
      potentialAction: {
      "@type": "SearchAction",
        target: `${toAbsoluteUrl("/jobs")}?position={search_term_string}`,
        "query-input": "required name=search_term_string",
      },
    },
    {
      "@type": "Organization",
      name: "Telecommut",
      url: toAbsoluteUrl("/"),
      logo: toAbsoluteUrl("/logo.png"),
    },
    {
      "@type": "WebPage",
      name: "Remote Jobs Board",
      url: toAbsoluteUrl("/"),
      description: homepageDescription,
      inLanguage: "en",
      isPartOf: {
        "@type": "WebSite",
        name: "Telecommut",
        url: toAbsoluteUrl("/"),
      },
    },
  ],
};
---

<PublicLayout
  title="Remote Jobs Board"
  description={homepageDescription}
  keywords="remote jobs, work from home jobs, remote software jobs, remote design jobs, distributed teams"
  canonicalPath="/"
  jsonLd={homepageJsonLd}
>
  <div class="space-y-8">
    <section class="glass-panel relative z-50 overflow-visible rounded-3xl border p-7 shadow-sm md:p-10">
      <h1 class="max-w-3xl text-4xl font-semibold tracking-tight md:text-5xl">Find your new remote job</h1>
      <p class="mt-3 max-w-3xl text-sm text-muted-foreground md:text-base">{seoIntro}</p>
      <HomeSearchForm client:load initialQuery={query} initialCategory={category} categoryOptions={categoryOptions} />
    </section>

    <section class="recent-jobs relative z-10">
      <header class="section-header mb-5">
        <h2 class="mt-0 text-center text-3xl font-semibold tracking-tight">Recent Remote Jobs</h2>
      </header>
      <div class="space-y-4">
        {
          recentJobs.length === 0 ? (
            <article class="glass-panel rounded-2xl border p-5">
              <h3 class="text-xl font-semibold">No active jobs</h3>
              <p class="mt-2 text-sm text-muted-foreground">No active listings were found in the current dataset.</p>
            </article>
          ) : (
            recentJobs.map((job, index) => {
              const skillList = job.skills
                ? job.skills.split(",").map((skill) => skill.trim()).filter(Boolean).slice(0, 8)
                : [];
              const hasSalary = (job.salaryMin ?? 0) > 0 || (job.salaryMax ?? 0) > 0;

              return (
                <div class="space-y-4">
                  {
                    index === 1 && recentJobs.length > 3 ? (
                      <AdTop />
                    ) : null
                  }
                  <article class="glass-panel rounded-2xl border p-5 shadow-sm">
                    <div class="flex flex-wrap items-start justify-between gap-3">
                      <div class="flex items-start gap-3">
                        <img
                          src={resolveEmployerImage(job.userId === 1 ? job.companyLogo : "")}
                          alt=""
                          loading="lazy"
                          class="size-10 rounded-full border object-cover"
                        />
                        <div>
                        <a class="text-2xl font-semibold tracking-tight hover:underline" href={`/jobs/${job.id}`}>
                          {job.position}
                        </a>
                        <p class="mt-1 text-sm text-muted-foreground">{job.companyName || "Unknown company"}</p>
                        {
                          hasSalary ? (
                            <Badge className="mt-2 bg-emerald-100 text-emerald-900 hover:bg-emerald-100">
                              {formatSalary(job.salaryMin, job.salaryMax, job.currency, job.salaryPeriod)}
                            </Badge>
                          ) : null
                        }
                        </div>
                      </div>
                    </div>
                    <p class="mt-4 text-sm text-muted-foreground">{excerpt(job.description)}</p>
                    {
                      skillList.length > 0 ? (
                        <div class="mt-4 flex flex-wrap gap-2">
                          {skillList.map((skill) => <span class="rounded-full bg-secondary px-3 py-1 text-xs font-medium">{skill}</span>)}
                        </div>
                      ) : null
                    }
                    <div class="mt-5 flex flex-wrap gap-2 text-xs">
                      <Badge className="bg-sky-100 text-sky-900 hover:bg-sky-100">
                        {job.contractTitle || "Contract not specified"}
                      </Badge>
                      <Badge className="bg-amber-100 text-amber-900 hover:bg-amber-100">
                        Posted: {relativeDate(job.updatedAt)}
                      </Badge>
                      <Badge className="bg-slate-200 text-slate-900 hover:bg-slate-200">
                        {job.categoryTitle || "Uncategorized"}
                      </Badge>
                      <Badge className="bg-teal-100 text-teal-900 hover:bg-teal-100">
                        Hiring from: {resolveHiringFrom(job.countryGroups, job.countryName)}
                      </Badge>
                    </div>
                  </article>
                </div>
              );
            })
          )
        }
      </div>
    </section>

    <section class="ad-middle">
      <AdMiddle />
    </section>

    <section class="popular-categories mt-5">
      <h2 class="mb-5 text-center text-3xl font-semibold tracking-tight">Categories</h2>
      <div class="category-grid mt-2 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
        {
          categoryRows.map((row) => {
            const segment = categoryPathSegment(row);
            const content = (
              <div class="flex items-start gap-3">
                <span class="inline-flex size-9 shrink-0 items-center justify-center rounded-lg bg-secondary text-secondary-foreground">
                  <CategoryIcon name={row.icon} className="size-4" />
                </span>
                <div>
                  <h3 class="text-base font-semibold">{row.title}</h3>
                  <p class="mt-1 text-sm text-muted-foreground">{row.jobsCount} jobs</p>
                </div>
              </div>
            );
            return segment ? (
              <a class="glass-panel rounded-2xl border p-4 transition-colors hover:bg-card/80" href={`/categories/${segment}`}>
                {content}
              </a>
            ) : (
              <div class="glass-panel rounded-2xl border p-4">{content}</div>
            );
          })
        }
      </div>
    </section>
  </div>
</PublicLayout>
