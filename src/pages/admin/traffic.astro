---
import { desc } from "drizzle-orm";

import AdminDataTable from "@/components/admin/AdminDataTable.astro";
import { getRequestDb } from "@/db/request";
import { directTraffic } from "@/db/schema";
import { buildPaginationState } from "@/lib/pagination";
import AdminLayout from "@/layouts/admin/AdminLayout.astro";

export const prerender = false;

const pagination = buildPaginationState(Astro.url.searchParams.get("page"), 25);

const db = getRequestDb(Astro.locals);
const columns = [
  { key: "id", label: "ID" },
  { key: "path", label: "Path" },
  { key: "hits", label: "Hits" },
  { key: "updatedAt", label: "Updated" },
];

const rowsRaw = await db
  .select()
  .from(directTraffic)
  .orderBy(desc(directTraffic.id))
  .limit(pagination.pageSize + 1)
  .offset(pagination.offset);

const hasNext = rowsRaw.length > pagination.pageSize;
const rows = rowsRaw.slice(0, pagination.pageSize).map((row) => ({
  id: row.id ?? "-",
  path: row.trafficDate ?? "-",
  hits: row.totalNginxRequests ?? 0,
  updatedAt: row.trafficDate ?? "-",
}));

const prevHref = pagination.page > 1 ? `/admin/traffic?page=${pagination.page - 1}` : undefined;
const nextHref = hasNext ? `/admin/traffic?page=${pagination.page + 1}` : undefined;
---

<AdminLayout title="Traffic" description="Admin traffic module scaffold.">
  <section class="mb-5">
    <h2 class="mt-2 text-3xl font-semibold tracking-tight">Traffic</h2>
    <p class="mt-2 text-sm text-muted-foreground">
      Inspect daily traffic snapshots and request-volume signals from the edge.
    </p>
  </section>
  <AdminDataTable title="Traffic" columns={columns} rows={rows} prevHref={prevHref} nextHref={nextHref} />
</AdminLayout>
