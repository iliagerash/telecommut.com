---
import { getRequestDb } from "@/db/request";
import { authUsers, jobs, resumes } from "@/db/schema";
import AdminLayout from "@/layouts/admin/AdminLayout.astro";

export const prerender = false;

const db = getRequestDb(Astro.locals);

const allJobs = await db.select().from(jobs);
const allResumes = await db.select().from(resumes);
const allUsers = await db.select().from(authUsers);
const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

const openJobs = allJobs.length;
const activeResumes = allResumes.length;
const newUsers7d = allUsers.filter((user) => {
  if (!user.createdAt || typeof user.createdAt !== "number") {
    return false;
  }

  return Number.isFinite(user.createdAt) && user.createdAt >= sevenDaysAgo;
}).length;
---

<AdminLayout title="Dashboard" description="Admin dashboard scaffold.">
  <section class="mb-5">
    <h2 class="mt-2 text-3xl font-semibold tracking-tight">Admin Dashboard</h2>
    <p class="mt-2 text-sm text-muted-foreground">
      Live counts sourced from the database with role-protected access controls.
    </p>
  </section>

  <section class="grid gap-4 md:grid-cols-3">
    <article class="glass-panel rounded-2xl border p-5 shadow-sm">
      <h3 class="text-sm font-medium text-muted-foreground">Open Jobs</h3>
      <p class="mt-2 text-3xl font-semibold">{openJobs}</p>
    </article>
    <article class="glass-panel rounded-2xl border p-5 shadow-sm">
      <h3 class="text-sm font-medium text-muted-foreground">Active Resumes</h3>
      <p class="mt-2 text-3xl font-semibold">{activeResumes}</p>
    </article>
    <article class="glass-panel rounded-2xl border p-5 shadow-sm">
      <h3 class="text-sm font-medium text-muted-foreground">New Users (7d)</h3>
      <p class="mt-2 text-3xl font-semibold">{newUsers7d}</p>
    </article>
  </section>
  <p class="mt-6 text-sm text-muted-foreground">
    Dashboard modules for jobs, resumes, users, SEO, and traffic share the same paginated table system.
  </p>
</AdminLayout>
