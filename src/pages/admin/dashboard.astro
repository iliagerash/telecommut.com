---
import { getRequestDb } from "@/db/request";
import { jobs, resumes, users } from "@/db/schema";
import AdminLayout from "@/layouts/admin/AdminLayout.astro";

export const prerender = false;

const db = getRequestDb(Astro.locals);

const allJobs = await db.select().from(jobs);
const allResumes = await db.select().from(resumes);
const allUsers = await db.select().from(users);
const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

const openJobs = allJobs.length;
const activeResumes = allResumes.length;
const newUsers7d = allUsers.filter((user) => {
  if (!user.createdAt) {
    return false;
  }

  const ts = new Date(user.createdAt).getTime();
  return Number.isFinite(ts) && ts >= sevenDaysAgo;
}).length;
---

<AdminLayout title="Dashboard" description="Admin dashboard scaffold.">
  <section class="grid gap-4 md:grid-cols-3">
    <article class="rounded-md border p-4">
      <h2 class="text-sm font-medium text-muted-foreground">Open Jobs</h2>
      <p class="mt-2 text-2xl font-semibold">{openJobs}</p>
    </article>
    <article class="rounded-md border p-4">
      <h2 class="text-sm font-medium text-muted-foreground">Active Resumes</h2>
      <p class="mt-2 text-2xl font-semibold">{activeResumes}</p>
    </article>
    <article class="rounded-md border p-4">
      <h2 class="text-sm font-medium text-muted-foreground">New Users (7d)</h2>
      <p class="mt-2 text-2xl font-semibold">{newUsers7d}</p>
    </article>
  </section>
  <p class="mt-6 text-sm text-muted-foreground">Dashboard metrics are now sourced from DB counts.</p>
</AdminLayout>
