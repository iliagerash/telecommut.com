---
import { eq } from "drizzle-orm";

import { Badge } from "@/components/ui/badge";
import { getRequestDb } from "@/db/request";
import { authUsers, categories, jobs } from "@/db/schema";
import AdminLayout from "@/layouts/AdminLayout.astro";
import { formatDescriptionHtml } from "@/lib/description";

export const prerender = false;

const id = Number.parseInt(String(Astro.params.id ?? ""), 10);
if (!Number.isFinite(id) || id <= 0) {
  throw new Response("Not found", { status: 404 });
}

const db = getRequestDb(Astro.locals);
const rows = await db
  .select()
  .from(jobs)
  .leftJoin(authUsers, eq(jobs.userId, authUsers.id))
  .leftJoin(categories, eq(jobs.categoryId, categories.id))
  .where(eq(jobs.id, id))
  .limit(1);

if (rows.length === 0) {
  throw new Response("Not found", { status: 404 });
}

const row = rows[0];
const job = row.jobs;
const owner = row.auth_users;
const category = row.categories;
const skills = (job.skills ?? "").split(",").map((item) => item.trim()).filter(Boolean);
const applyText = (job.applyText ?? "").trim();
const fallbackUrl = (job.url ?? "").trim();

function formatDate(value: string | null): string {
  if (!value) return "-";
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;
  return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
}
---

<AdminLayout title={`Job #${job.id}`} description="Admin job detail.">
  <section class="mb-5">
    <h2 class="mt-2 text-3xl font-semibold tracking-tight">Job #{job.id}</h2>
    <p class="mt-2 text-sm text-muted-foreground">{job.position}</p>
  </section>

  <section class="glass-panel rounded-2xl border p-5 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-3">
      <div>
        <h3 class="text-xl font-semibold">{job.companyName || "Unknown company"}</h3>
        <p class="mt-1 text-sm text-muted-foreground">{category?.title ?? "Uncategorized"}</p>
      </div>
      <Badge className={job.status === 1 ? "bg-emerald-100 text-emerald-900 hover:bg-emerald-100" : "bg-amber-100 text-amber-900 hover:bg-amber-100"}>
        {job.status === 1 ? "Approved" : "Pending"}
      </Badge>
    </div>

    <div class="mt-4 grid gap-2 text-sm md:grid-cols-2">
      <p><strong>Date:</strong> {formatDate(job.updatedAt)}</p>
      <p><strong>Owner email:</strong> {owner?.email ?? "-"}</p>
      <p><strong>Salary:</strong> {job.salaryMin > 0 || job.salaryMax > 0 ? `${job.salaryMin}-${job.salaryMax} ${job.currency}/${job.salaryPeriod}` : "-"}</p>
      <p><strong>Contract:</strong> {job.contractCode ?? "-"}</p>
    </div>

    {
      skills.length > 0 ? (
        <div class="mt-4 flex flex-wrap gap-2">
          {skills.map((skill) => <span class="rounded-full bg-secondary px-3 py-1 text-xs font-medium">{skill}</span>)}
        </div>
      ) : null
    }

    <article class="prose prose-sm mt-5 max-w-none" set:html={formatDescriptionHtml(job.description)} />

    <div class="mt-5">
      <h4 class="text-lg font-semibold">How to apply</h4>
      {
        applyText ? (
          <p class="mt-2 text-sm">{applyText}</p>
        ) : fallbackUrl ? (
          <p class="mt-2 text-sm">
            <a class="text-blue-600 underline" href={fallbackUrl} target="_blank" rel="noreferrer">{fallbackUrl}</a>
          </p>
        ) : (
          <p class="mt-2 text-sm text-muted-foreground">No apply instructions.</p>
        )
      }
    </div>
  </section>
</AdminLayout>
