---
import { eq } from "drizzle-orm";

import { Badge } from "@/components/ui/badge";
import { getRequestDb } from "@/db/request";
import { authUsers, categories, resumes } from "@/db/schema";
import AdminLayout from "@/layouts/AdminLayout.astro";
import { formatDescriptionHtml } from "@/lib/description";

export const prerender = false;

const id = Number.parseInt(String(Astro.params.id ?? ""), 10);
if (!Number.isFinite(id) || id <= 0) {
  throw new Response("Not found", { status: 404 });
}

const db = getRequestDb(Astro.locals);
const rows = await db
  .select()
  .from(resumes)
  .leftJoin(authUsers, eq(resumes.userId, authUsers.id))
  .leftJoin(categories, eq(resumes.categoryId, categories.id))
  .where(eq(resumes.id, id))
  .limit(1);

if (rows.length === 0) {
  throw new Response("Not found", { status: 404 });
}

const row = rows[0];
const resume = row.resumes;
const owner = row.auth_users;
const category = row.categories;
const skills = (resume.skills ?? "").split(",").map((item) => item.trim()).filter(Boolean);

function formatDate(value: Date | string | null): string {
  if (!value) return "-";
  const date = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(date.getTime())) return String(value);
  return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
}
---

<AdminLayout title={`Resume #${resume.id}`} description="Admin resume detail.">
  <section class="mb-5">
    <h2 class="mt-2 text-3xl font-semibold tracking-tight">Resume #{resume.id}</h2>
    <p class="mt-2 text-sm text-muted-foreground">{resume.position}</p>
  </section>

  <section class="glass-panel rounded-2xl border p-5 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-3">
      <div>
        <h3 class="text-xl font-semibold">{owner?.candidateName || "Candidate profile"}</h3>
        <p class="mt-1 text-sm text-muted-foreground">{category?.title ?? "Uncategorized"}</p>
      </div>
      <Badge className={resume.status === 1 ? "bg-emerald-100 text-emerald-900 hover:bg-emerald-100" : "bg-amber-100 text-amber-900 hover:bg-amber-100"}>
        {resume.status === 1 ? "Visible" : "Hidden"}
      </Badge>
    </div>

    <div class="mt-4 grid gap-2 text-sm md:grid-cols-2">
      <p><strong>Date:</strong> {formatDate(resume.updatedAt)}</p>
      <p><strong>Email:</strong> {owner?.email ?? "-"}</p>
      <p><strong>Phone:</strong> {owner?.candidatePhone ?? "-"}</p>
      <p><strong>Salary:</strong> {resume.salaryMin > 0 ? `${resume.salaryMin} ${resume.currency}/${resume.salaryPeriod}` : "-"}</p>
    </div>

    {
      skills.length > 0 ? (
        <div class="mt-4 flex flex-wrap gap-2">
          {skills.map((skill) => <span class="rounded-full bg-secondary px-3 py-1 text-xs font-medium">{skill}</span>)}
        </div>
      ) : null
    }

    <article class="prose prose-sm mt-5 max-w-none" set:html={formatDescriptionHtml(resume.description)} />
  </section>
</AdminLayout>
