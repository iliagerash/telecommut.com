---
import PublicLayout from "@/layouts/PublicLayout.astro";

const token = Astro.url.searchParams.get("token");
if (token) {
  const callbackURL =
    Astro.url.searchParams.get("callbackURL") ??
    `${Astro.url.origin}/app/profile`;
  const target = new URL("/api/auth/verify-email", Astro.url.origin);
  target.searchParams.set("token", token);
  target.searchParams.set("callbackURL", callbackURL);
  return Astro.redirect(target.toString(), 302);
}

const status = Astro.url.searchParams.get("status");
const error = Astro.url.searchParams.get("error");
const email = Astro.url.searchParams.get("email") ?? "";
---

<PublicLayout
  title="Verify Email"
  description="Verify your Telecommut account email address."
  robots="noindex,nofollow"
>
  <section class="glass-panel mx-auto w-full max-w-xl rounded-3xl border p-6 shadow-sm md:p-8">
    <h1 class="mt-3 text-4xl font-semibold tracking-tight">Verify your email</h1>
    <p class="mt-3 text-muted-foreground">
      Use the link from your inbox to verify your account. If the email is missing or expired, request a new one below.
    </p>

    {status === "verified" ? (
      <div class="mt-5 rounded-xl border border-emerald-400/40 bg-emerald-500/10 p-3 text-sm text-emerald-900">
        Email verified successfully. You can now login.
      </div>
    ) : null}

    {error ? (
      <div class="mt-5 rounded-xl border border-red-400/40 bg-red-500/10 p-3 text-sm text-red-900">
        Verification failed: {error.replaceAll("_", " ")}.
      </div>
    ) : null}

    <form id="resend-form" class="mt-6 space-y-3">
      <div>
        <label class="sr-only" for="verify-email-input">Email</label>
        <input
          id="verify-email-input"
          name="email"
          type="email"
          required
          value={email}
          placeholder="Email *"
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          autocomplete="email"
        />
      </div>
      <div class="flex items-center gap-3">
        <button
          id="resend-submit"
          type="submit"
          class="rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground hover:opacity-90"
        >
          Resend verification email
        </button>
        <p id="resend-status" class="text-sm text-muted-foreground" role="status" aria-live="polite"></p>
      </div>
    </form>

  </section>

  <script is:inline>
    const form = document.getElementById("resend-form");
    const statusEl = document.getElementById("resend-status");
    const submit = document.getElementById("resend-submit");
    const emailInput = document.getElementById("verify-email-input");

    function clearInputError(input) {
      if (!(input instanceof HTMLInputElement)) return;
      input.classList.remove("border-red-500", "ring-2", "ring-red-300");
    }

    function setInputError(input) {
      if (!(input instanceof HTMLInputElement)) return;
      input.classList.add("border-red-500", "ring-2", "ring-red-300");
    }

    function setStatus(message, kind = "info") {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove("text-muted-foreground", "text-red-600", "text-emerald-700");
      if (kind === "error") statusEl.classList.add("text-red-600");
      else if (kind === "success") statusEl.classList.add("text-emerald-700");
      else statusEl.classList.add("text-muted-foreground");
    }

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!statusEl || !submit || !(form instanceof HTMLFormElement)) return;

      clearInputError(emailInput);
      const formData = new FormData(form);
      const email = String(formData.get("email") ?? "").trim().toLowerCase();
      if (!email) {
        setInputError(emailInput);
        setStatus("Email is required.", "error");
        return;
      }

      submit.setAttribute("disabled", "disabled");
      setStatus("Sending...");

      try {
        const callbackURL = `${window.location.origin}/app/profile`;
        const response = await fetch("/api/auth/send-verification-email", {
          method: "POST",
          credentials: "omit",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ email, callbackURL }),
        });
        const json = await response.json().catch(() => null);
        if (!response.ok) {
          const message = typeof json?.message === "string" ? json.message : "Unable to resend verification email.";
          setInputError(emailInput);
          setStatus(message, "error");
          return;
        }
        setStatus("Verification email sent. Check your inbox.", "success");
      } catch {
        setStatus("Unable to complete request. Please try again.", "error");
      } finally {
        submit.removeAttribute("disabled");
      }
    });
  </script>
</PublicLayout>
