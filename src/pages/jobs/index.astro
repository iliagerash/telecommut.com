---
import { and, desc, eq, sql } from "drizzle-orm";

import AdMiddle from "@/components/ads/AdMiddle.astro";
import AdTop from "@/components/ads/AdTop.astro";
import { Badge } from "@/components/ui/badge";
import { getRequestDb } from "@/db/request";
import { categories, contracts, countries, countryGroups, jobs } from "@/db/schema";
import PublicLayout from "@/layouts/PublicLayout.astro";
import { buildPaginationState } from "@/lib/pagination";
import { toAbsoluteUrl } from "@/lib/seo";

export const prerender = false;

const db = getRequestDb(Astro.locals);

const query = (Astro.url.searchParams.get("q") ?? Astro.url.searchParams.get("position") ?? "").trim();
const categoryParam = (Astro.url.searchParams.get("category") ?? Astro.url.searchParams.get("category_id") ?? "").trim();
const pagination = buildPaginationState(Astro.url.searchParams.get("page"), 20);

const parsedCategory = Number.parseInt(categoryParam, 10);
const categoryId = Number.isFinite(parsedCategory) && parsedCategory > 0 ? parsedCategory : null;

const categoryRowsRaw = await db.select().from(categories).orderBy(categories.title);
const countryGroupRowsRaw = await db.select().from(countryGroups);
const countryGroupRows = countryGroupRowsRaw.map((row) => ({ id: row.id, name: row.name }));

if (!query && categoryId !== null) {
  const categorySegment = categoryRowsRaw.find((row) => row.id === categoryId)?.slug?.trim();
  if (categorySegment) {
    return Astro.redirect(`/category/${encodeURIComponent(categorySegment)}`, 307);
  }
}

const whereClauses = [eq(jobs.status, 1)];
if (query) {
  whereClauses.push(sql`lower(${jobs.position}) like ${`%${query.toLowerCase()}%`}`);
}
if (categoryId !== null) {
  whereClauses.push(eq(jobs.categoryId, categoryId));
}

const resultRows = await db
  .select()
  .from(jobs)
  .leftJoin(categories, eq(jobs.categoryId, categories.id))
  .leftJoin(countries, eq(jobs.countryId, countries.id))
  .leftJoin(contracts, eq(jobs.contractCode, contracts.code))
  .where(and(...whereClauses))
  .orderBy(desc(jobs.id))
  .limit(pagination.pageSize + 1)
  .offset(pagination.offset);

const hasNext = resultRows.length > pagination.pageSize;
const allMatchingRows = await db.select().from(jobs).where(and(...whereClauses));
const totalResults = allMatchingRows.length;
const items = resultRows.slice(0, pagination.pageSize).map((row) => ({
  id: row.jobs.id,
  position: row.jobs.position,
  companyName: row.jobs.companyName,
  salaryMin: row.jobs.salaryMin,
  salaryMax: row.jobs.salaryMax,
  currency: row.jobs.currency,
  salaryPeriod: row.jobs.salaryPeriod,
  description: row.jobs.description,
  skills: row.jobs.skills,
  updatedAt: row.jobs.updatedAt,
  countryGroups: row.jobs.countryGroups,
  categoryTitle: row.categories?.title ?? null,
  countryName: row.countries?.name ?? null,
  contractTitle: row.contracts?.title ?? null,
}));

if (pagination.page > 1 && items.length === 0) {
  throw new Response("Not found", { status: 404 });
}

const categoryTitle = categoryId !== null ? (categoryRowsRaw.find((row) => row.id === categoryId)?.title ?? null) : null;
const countryGroupNameById = new Map(countryGroupRows.map((row) => [String(row.id), row.name]));
const noAds = items.length === 0;
const prevPage = pagination.page > 1 ? pagination.page - 1 : null;
const nextPage = hasNext ? pagination.page + 1 : null;
const robots = query ? "noindex,nofollow" : "index,follow";

const heading = query ? `Remote jobs for "${query}"` : "Remote Job Search";
const headingWithCategory = categoryTitle ? `${heading} in ${categoryTitle}` : heading;
const pageHeading = pagination.page > 1 ? `${headingWithCategory} - page ${pagination.page}` : headingWithCategory;
const pageTitle = pagination.page > 1 ? `Job Search - Page ${pagination.page}` : "Job Search";
const pageDescription = query
  ? `Search results for ${query}${categoryTitle ? ` in ${categoryTitle}` : ""}.`
  : categoryTitle
    ? `Browse remote jobs in ${categoryTitle}.`
    : "Browse and search jobs.";

function buildPageHref(page: number): string {
  const url = new URL("/jobs", Astro.url);
  if (query) {
    url.searchParams.set("q", query);
  }
  if (categoryId !== null) {
    url.searchParams.set("category", String(categoryId));
  }
  if (page > 1) {
    url.searchParams.set("page", String(page));
  }
  return `${url.pathname}${url.search}`;
}

const canonicalPath = buildPageHref(pagination.page);

function plainText(input: string | null): string {
  if (!input) return "";
  return input.replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
}

function excerpt(input: string | null, maxWords = 40): string {
  const words = plainText(input).split(/\s+/).filter(Boolean);
  if (words.length <= maxWords) return words.join(" ");
  return `${words.slice(0, maxWords).join(" ")}...`;
}

function formatSalary(min: number | null, max: number | null, currency: string | null, period: string | null): string {
  const hasMin = (min ?? 0) > 0;
  const hasMax = (max ?? 0) > 0;
  if (!hasMin && !hasMax) return "Salary not specified";

  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
  const parts = [];
  if (hasMin) parts.push(formatter.format(min ?? 0));
  if (hasMax) {
    if (parts.length > 0) parts.push("-");
    parts.push(formatter.format(max ?? 0));
  }

  const unit = currency && period ? ` ${currency} / ${period}` : "";
  return `${parts.join(" ")}${unit}`;
}

function relativeDate(dateValue: Date | string | null): string {
  if (!dateValue) return "Recently";
  const date = dateValue instanceof Date ? dateValue : new Date(dateValue);
  if (Number.isNaN(date.getTime())) return "Recently";

  const deltaSeconds = Math.round((date.getTime() - Date.now()) / 1000);
  const abs = Math.abs(deltaSeconds);
  const rtf = new Intl.RelativeTimeFormat("en", { numeric: "auto" });

  if (abs < 60) return rtf.format(Math.round(deltaSeconds), "second");
  if (abs < 3600) return rtf.format(Math.round(deltaSeconds / 60), "minute");
  if (abs < 86400) return rtf.format(Math.round(deltaSeconds / 3600), "hour");
  if (abs < 604800) return rtf.format(Math.round(deltaSeconds / 86400), "day");
  return rtf.format(Math.round(deltaSeconds / 604800), "week");
}

function resolveHiringFrom(countryGroupsValue: string | null, countryName: string | null): string {
  const normalized = (countryGroupsValue ?? "").trim();
  if (!normalized || normalized === "0") {
    return countryName?.trim() || "Worldwide";
  }

  const keys = normalized
    .split(",")
    .map((value) => value.trim())
    .filter(Boolean)
    .filter((value) => value !== "0");

  const labels = keys
    .map((key) => countryGroupNameById.get(key))
    .filter((value): value is string => Boolean(value));

  return labels.length > 0 ? labels.join(", ") : countryName?.trim() || "Worldwide";
}

const resultSummary = totalResults > 0
  ? `Results ${pagination.offset + 1}-${pagination.offset + items.length} of ${totalResults}`
  : "No jobs found";
---

<PublicLayout
  title={pageTitle}
  description={pageDescription}
  canonicalPath={canonicalPath}
  robots={robots}
  prevPath={prevPage ? buildPageHref(prevPage) : undefined}
  nextPath={nextPage ? buildPageHref(nextPage) : undefined}
  noAds={noAds}
  jsonLd={{
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "CollectionPage",
        name: pageHeading,
        url: toAbsoluteUrl(canonicalPath),
        description: pageDescription,
      },
      {
        "@type": "BreadcrumbList",
        itemListElement: [
          { "@type": "ListItem", position: 1, name: "Home", item: toAbsoluteUrl("/") },
          { "@type": "ListItem", position: 2, name: "Job Search", item: toAbsoluteUrl("/jobs") },
        ],
      },
    ],
  }}
>
  <section class="glass-panel rounded-3xl border p-6 shadow-sm md:p-8">
    <h1 class="text-4xl font-semibold tracking-tight">{pageHeading}</h1>
    <p class="mt-3 text-sm text-muted-foreground">{resultSummary}</p>
  </section>

  {
    items.length === 0 ? (
      <section class="mt-4">
        <article class="glass-panel rounded-2xl border p-5">
          <h2 class="text-2xl font-semibold tracking-tight">No matching jobs found</h2>
          <p class="mt-2 text-sm text-muted-foreground">
            Try broader keywords or remove the category filter.
          </p>
        </article>
      </section>
    ) : (
      <section class="mt-4 space-y-4">
        {
          items.map((job, index) => {
            const skillList = job.skills
              ? job.skills.split(",").map((skill) => skill.trim()).filter(Boolean).slice(0, 8)
              : [];
            const hasSalary = (job.salaryMin ?? 0) > 0 || (job.salaryMax ?? 0) > 0;

            return (
              <>
                {
                  index === 1 && items.length > 3 ? (
                    <AdTop />
                  ) : null
                }
                {
                  index === 5 && items.length > 8 ? (
                    <AdMiddle />
                  ) : null
                }
                <article class="glass-panel rounded-2xl border p-5 shadow-sm">
                  <div class="flex flex-wrap items-start justify-between gap-3">
                    <div>
                      <a class="text-2xl font-semibold tracking-tight hover:underline" href={`/jobs/${job.id}`}>
                        {job.position}
                      </a>
                      <p class="mt-1 text-sm text-muted-foreground">{job.companyName || "Unknown company"}</p>
                      {
                        hasSalary ? (
                          <Badge className="mt-2 bg-emerald-100 text-emerald-900 hover:bg-emerald-100">
                            {formatSalary(job.salaryMin, job.salaryMax, job.currency, job.salaryPeriod)}
                          </Badge>
                        ) : null
                      }
                    </div>
                  </div>

                  <p class="mt-4 text-sm text-muted-foreground">{excerpt(job.description)}</p>

                  {
                    skillList.length > 0 ? (
                      <div class="mt-4 flex flex-wrap gap-2">
                        {skillList.map((skill) => <span class="rounded-full bg-secondary px-3 py-1 text-xs font-medium">{skill}</span>)}
                      </div>
                    ) : null
                  }

                  <div class="mt-5 flex flex-wrap gap-2 text-xs">
                    <Badge className="bg-sky-100 text-sky-900 hover:bg-sky-100">
                      {job.contractTitle || "Contract not specified"}
                    </Badge>
                    <Badge className="bg-amber-100 text-amber-900 hover:bg-amber-100">
                      Posted: {relativeDate(job.updatedAt)}
                    </Badge>
                    <Badge className="bg-slate-200 text-slate-900 hover:bg-slate-200">
                      {job.categoryTitle || "Uncategorized"}
                    </Badge>
                    <Badge className="bg-teal-100 text-teal-900 hover:bg-teal-100">
                      Hiring from: {resolveHiringFrom(job.countryGroups, job.countryName)}
                    </Badge>
                  </div>
                </article>
              </>
            );
          })
        }
      </section>
    )
  }

  {
    nextPage ? (
      <nav class="mt-6 flex items-center gap-3 text-sm">
        {
          prevPage
            ? <a class="rounded-full border px-4 py-2 hover:bg-secondary" href={buildPageHref(prevPage)}>Previous</a>
            : <span class="rounded-full border px-4 py-2 text-muted-foreground">Previous</span>
        }
        <a class="rounded-full border px-4 py-2 hover:bg-secondary" href={buildPageHref(nextPage)}>Next</a>
      </nav>
    ) : null
  }
</PublicLayout>
