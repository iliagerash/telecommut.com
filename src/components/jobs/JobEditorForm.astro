---
type Option = {
  id: number;
  label: string;
};

type Choice = {
  value: string;
  label: string;
};

type JobEditorValues = {
  companyName: string;
  position: string;
  categoryId: string;
  countryId: string;
  salaryMin: string;
  salaryMax: string;
  salaryPeriod: string;
  currency: string;
  contractCode: string;
  skills: string;
  description: string;
  applyText: string;
  countryGroupsMode: "all" | "employer" | "regions";
  countryGroupIds: string[];
};

type Props = {
  action: string;
  submitLabel: string;
  returnTo: string;
  userEmail: string;
  userImage: string;
  profileName?: string;
  currencies: string[];
  categories: Option[];
  countries: Option[];
  contracts: Choice[];
  countryGroups: Option[];
  values: JobEditorValues;
  hasCurrencySeparator?: boolean;
  majorCurrencyCount?: number;
  errorText?: string;
  successText?: string;
  hiddenFields?: Record<string, string>;
};

const {
  action,
  submitLabel,
  returnTo,
  userEmail,
  userImage,
  profileName = "",
  currencies,
  categories,
  countries,
  contracts,
  countryGroups,
  values,
  hasCurrencySeparator = false,
  majorCurrencyCount = 0,
  errorText = "",
  successText = "",
  hiddenFields = {},
} = Astro.props;
---

{
  errorText ? <p class="mt-4 rounded-xl border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700">{errorText}</p> : null
}
{
  successText ? <p class="mt-4 rounded-xl border border-emerald-300 bg-emerald-50 px-3 py-2 text-sm text-emerald-700">{successText}</p> : null
}

<form class="mt-5 space-y-6" action={action} method="POST">
  <input type="hidden" name="return_to" value={returnTo} />
  {
    Object.entries(hiddenFields).map(([name, value]) => (
      <input type="hidden" name={name} value={value} />
    ))
  }

  <section class="rounded-2xl border bg-background p-4">
    <h2 class="text-lg font-semibold">Company data</h2>
    <div class="mt-4 grid gap-4 md:grid-cols-[96px_1fr] md:items-center">
    {
      userImage ? (
        <img
          src={userImage}
          alt=""
          class="size-24 rounded-xl border object-cover"
        />
      ) : (
        <div class="size-24 rounded-xl border bg-muted" aria-hidden="true"></div>
      )
    }
    <div class="space-y-2 text-sm">
      <p>
        <strong>Name:</strong> {profileName ? profileName : "set one in Edit profile"}
      </p>
      <p class="text-sm">
        Email: <a class="text-blue-700 underline" href={`mailto:${userEmail}`}>{userEmail}</a>
      </p>
      {
        userImage ? null : (
          <p class="text-sm text-muted-foreground">
            No profile image yet. Upload one in Edit profile.
          </p>
        )
      }
      <a class="text-blue-600 underline" href="/app/profile">Edit profile</a>
    </div>
    </div>
    <div class="mt-4">
      <label class="mb-1 block text-sm font-medium" for="company_name">Company name *</label>
      <input
        id="company_name"
        name="company_name"
        type="text"
        required
        value={values.companyName}
        class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
      />
    </div>
  </section>

  <section class="rounded-2xl border bg-background p-4">
    <h2 class="text-lg font-semibold">Job data</h2>

    <div class="mt-4 space-y-4">
      <div>
        <label class="mb-1 block text-sm font-medium" for="position">Position *</label>
        <input
          id="position"
          name="position"
          type="text"
          required
          value={values.position}
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
        />
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="relative">
          <label class="mb-1 block text-sm font-medium" for="category_id">Category *</label>
          <select
            id="category_id"
            name="category_id"
            required
            class="h-11 w-full appearance-none rounded-xl border bg-background px-3 pr-9 text-sm"
          >
            <option value="">Select category</option>
            {
              categories.map((category) => (
                <option value={String(category.id)} selected={String(category.id) === values.categoryId}>{category.label}</option>
              ))
            }
          </select>
          <span class="pointer-events-none absolute inset-y-0 right-3 top-6 flex items-center text-muted-foreground">▾</span>
        </div>
        <div class="relative">
          <label class="mb-1 block text-sm font-medium" for="country_id">Employer country *</label>
          <select
            id="country_id"
            name="country_id"
            required
            class="h-11 w-full appearance-none rounded-xl border bg-background px-3 pr-9 text-sm"
          >
            <option value="">Select country</option>
            {
              countries.map((country) => (
                <option value={String(country.id)} selected={String(country.id) === values.countryId}>{country.label}</option>
              ))
            }
          </select>
          <span class="pointer-events-none absolute inset-y-0 right-3 top-6 flex items-center text-muted-foreground">▾</span>
        </div>
      </div>

      <fieldset>
        <legend class="text-sm font-medium">Hiring from</legend>
        <div class="mt-2 grid gap-2">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="country-groups-all" name="country_groups_all" type="checkbox" value="1" checked={values.countryGroupsMode === "all"} />
            <span>Anywhere</span>
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input
              id="country-groups-employer"
              name="country_groups_employer"
              type="checkbox"
              value="1"
              checked={values.countryGroupsMode === "employer"}
            />
            <span>Employer country</span>
          </label>
          <p class="mt-1 text-sm text-muted-foreground">Select specific regions:</p>
          <div class="grid gap-2 sm:grid-cols-2">
            {
              countryGroups.map((item) => (
                <label class="inline-flex items-center gap-2 text-sm">
                  <input
                    class="country-groups-region"
                    name={`country_groups_arr[${item.id}]`}
                    type="checkbox"
                    value="1"
                    checked={values.countryGroupIds.includes(String(item.id))}
                  />
                  <span>{item.label}</span>
                </label>
              ))
            }
          </div>
        </div>
      </fieldset>

      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="mb-1 block text-sm font-medium" for="salary_min">Salary from</label>
          <input
            id="salary_min"
            name="salary_min"
            type="text"
            value={values.salaryMin}
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          />
        </div>
        <div>
          <label class="mb-1 block text-sm font-medium" for="salary_max">Salary to</label>
          <input
            id="salary_max"
            name="salary_max"
            type="text"
            value={values.salaryMax}
            class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
          />
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-3">
        <div class="relative">
          <label class="mb-1 block text-sm font-medium" for="salary_period">Per</label>
          <select
            id="salary_period"
            name="salary_period"
            class="h-11 w-full appearance-none rounded-xl border bg-background px-3 pr-9 text-sm"
          >
            <option value="hour" selected={values.salaryPeriod === "hour"}>hour</option>
            <option value="day" selected={values.salaryPeriod === "day"}>day</option>
            <option value="week" selected={values.salaryPeriod === "week"}>week</option>
            <option value="month" selected={values.salaryPeriod === "month"}>month</option>
            <option value="year" selected={values.salaryPeriod === "year"}>year</option>
          </select>
          <span class="pointer-events-none absolute inset-y-0 right-3 top-6 flex items-center text-muted-foreground">▾</span>
        </div>
        <div class="relative">
          <label class="mb-1 block text-sm font-medium" for="currency">Currency</label>
          <select id="currency" name="currency" class="h-11 w-full appearance-none rounded-xl border bg-background px-3 pr-9 text-sm">
            {currencies.slice(0, majorCurrencyCount).map((currency) => (
              <option value={currency} selected={currency === values.currency}>{currency}</option>
            ))}
            {hasCurrencySeparator ? <option disabled>──────────</option> : null}
            {currencies.slice(majorCurrencyCount).map((currency) => (
              <option value={currency} selected={currency === values.currency}>{currency}</option>
            ))}
          </select>
          <span class="pointer-events-none absolute inset-y-0 right-3 top-6 flex items-center text-muted-foreground">▾</span>
        </div>
        <div class="relative">
          <label class="mb-1 block text-sm font-medium" for="contract_code">Employment type</label>
          <select
            id="contract_code"
            name="contract_code"
            class="h-11 w-full appearance-none rounded-xl border bg-background px-3 pr-9 text-sm"
          >
            {
              contracts.map((contract) => (
                <option value={contract.value} selected={contract.value === values.contractCode}>{contract.label}</option>
              ))
            }
          </select>
          <span class="pointer-events-none absolute inset-y-0 right-3 top-6 flex items-center text-muted-foreground">▾</span>
        </div>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium" for="skills">Skills (comma separated)</label>
        <input
          id="skills"
          name="skills"
          type="text"
          value={values.skills}
          class="h-11 w-full rounded-xl border bg-background px-3 text-sm"
        />
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium" for="description">Job text *</label>
        <textarea
          id="description"
          name="description"
          rows="10"
          required
          class="w-full rounded-xl border bg-background px-3 py-2 text-sm"
        >{values.description}</textarea>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium" for="apply_text">How to apply</label>
        <textarea
          id="apply_text"
          name="apply_text"
          rows="5"
          class="w-full rounded-xl border bg-background px-3 py-2 text-sm"
        >{values.applyText}</textarea>
        <p class="mt-2 text-xs text-muted-foreground">
          Use this field to specify URL, email or other apply options instead of profile contact data.
        </p>
      </div>
    </div>
  </section>

  <div class="flex items-center gap-3">
    <button
      type="submit"
      class="rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground hover:opacity-90"
    >
      {submitLabel}
    </button>
    <a class="rounded-xl border px-5 py-2.5 text-sm font-semibold hover:bg-secondary" href="/app/jobs/list">Cancel</a>
  </div>
</form>

<script>
  const allCheckbox = document.getElementById("country-groups-all");
  const employerCheckbox = document.getElementById("country-groups-employer");
  const regionCheckboxes = Array.from(document.querySelectorAll(".country-groups-region"));

  if (allCheckbox instanceof HTMLInputElement && employerCheckbox instanceof HTMLInputElement && regionCheckboxes.length > 0) {
    const syncFromAll = () => {
      if (!allCheckbox.checked) return;
      employerCheckbox.checked = false;
      regionCheckboxes.forEach((item) => {
        if (item instanceof HTMLInputElement) item.checked = false;
      });
    };
    const syncFromEmployer = () => {
      if (!employerCheckbox.checked) return;
      allCheckbox.checked = false;
      regionCheckboxes.forEach((item) => {
        if (item instanceof HTMLInputElement) item.checked = false;
      });
    };
    const syncFromRegion = (target: unknown) => {
      if (!(target instanceof HTMLInputElement) || !target.checked) return;
      allCheckbox.checked = false;
      employerCheckbox.checked = false;
    };

    allCheckbox.addEventListener("change", syncFromAll);
    employerCheckbox.addEventListener("change", syncFromEmployer);
    regionCheckboxes.forEach((item) => {
      if (item instanceof HTMLInputElement) {
        item.addEventListener("change", () => syncFromRegion(item));
      }
    });
  }
</script>
