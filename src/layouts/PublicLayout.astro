---
import "../styles/global.css";
import AdBottom from "@/components/ads/AdBottom.astro";
import PublicDesktopNav from "@/components/navigation/PublicDesktopNav";
import PublicMobileNav from "@/components/navigation/PublicMobileNav";
import { getAuth } from "@/auth";
import { normalizeHeaderUserType } from "@/components/navigation/public-nav";
import type { HeaderUserType } from "@/components/navigation/public-nav";
import { serializeJsonLd, toAbsoluteUrl } from "@/lib/seo";

interface Props {
  title: string;
  description?: string;
  keywords?: string;
  canonicalPath?: string;
  robots?: string;
  prevPath?: string;
  nextPath?: string;
  socialImagePath?: string;
  jsonLd?: Record<string, unknown> | Array<Record<string, unknown>>;
  noAds?: boolean;
}

const {
  title,
  description = "Telecommut public route scaffold.",
  keywords,
  canonicalPath = `${Astro.url.pathname}${Astro.url.search}`,
  robots = "index,follow",
  prevPath,
  nextPath,
  socialImagePath = "/brand/og-default.png",
  jsonLd,
  noAds = false,
} = Astro.props;

const canonicalHref = toAbsoluteUrl(canonicalPath);
const prevHref = prevPath ? toAbsoluteUrl(prevPath) : null;
const nextHref = nextPath ? toAbsoluteUrl(nextPath) : null;
const jsonLdString = serializeJsonLd(jsonLd);
const socialImageHref = toAbsoluteUrl(socialImagePath);
const showAds = ["1", "true", "yes", "on"].includes(
  String(import.meta.env.SHOW_ADS ?? "").trim().toLowerCase(),
);
let initialUserType: HeaderUserType = "guest";
try {
  const session = await getAuth(Astro.locals).api.getSession({
    headers: Astro.request.headers,
  });
  initialUserType = normalizeHeaderUserType(session?.user ?? null);
} catch {
  initialUserType = "guest";
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/brand/logo-mark.png" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    {keywords ? <meta name="keywords" content={keywords} /> : null}
    <meta name="robots" content={robots} />
    <meta name="bingbot" content={robots} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Telecommut" />
    <meta property="og:url" content={canonicalHref} />
    <meta property="og:title" content={`${title} | Telecommut`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageHref} />
    <meta property="og:image:type" content="image/png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${title} | Telecommut`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageHref} />
    <link rel="canonical" href={canonicalHref} />
    {prevHref ? <link rel="prev" href={prevHref} /> : null}
    {nextHref ? <link rel="next" href={nextHref} /> : null}
    {jsonLdString ? <script is:inline type="application/ld+json" set:html={jsonLdString} /> : null}
    {
      showAds && !noAds ? (
        <script
          is:inline
          async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2736122797193888"
          crossorigin="anonymous"
        ></script>
      ) : null
    }
    <title>{title} | Telecommut</title>
  </head>
  <body>
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:fixed focus:top-3 focus:left-3 focus:z-50 focus:rounded-md focus:bg-primary focus:px-3 focus:py-2 focus:text-primary-foreground"
    >
      Skip to main content
    </a>
    <div class="bg-brand-grid min-h-screen">
      <header class="relative z-[80] border-b bg-primary/95 text-primary-foreground shadow-sm">
        <div class="mx-auto flex w-full max-w-6xl items-center gap-4 px-5 py-4">
          <a href="/" class="flex items-center gap-3 text-sm font-semibold tracking-[0.14em] uppercase">
            <img src="/brand/logo-mark.svg" alt="" width="26" height="26" loading="eager" />
            Telecommut
          </a>
          <PublicDesktopNav client:load initialUserType={initialUserType} />
          <div class="ml-auto md:hidden">
            <PublicMobileNav client:load initialUserType={initialUserType} />
          </div>
        </div>
      </header>

      <main class="mx-auto w-full max-w-6xl px-5 py-8 md:py-10">
        <section id="main-content">
          <slot />
        </section>
        {showAds && !noAds ? <AdBottom /> : null}
      </main>

      <footer class="border-t bg-card/70">
        <div class="mx-auto grid w-full max-w-6xl gap-8 px-5 py-8 md:grid-cols-[1.8fr_1fr]">
          <section>
            <h2 class="text-sm font-semibold tracking-[0.16em] text-muted-foreground uppercase">About</h2>
            <p class="mt-3 max-w-3xl text-sm text-muted-foreground">
              Telecommut is a remote hiring marketplace focused on practical matching between distributed teams and
              high-signal candidates. We prioritize clear job briefs, profile quality, and predictable moderation.
            </p>
          </section>
          <section>
            <h2 class="text-sm font-semibold tracking-[0.16em] text-muted-foreground uppercase">Information</h2>
            <ul class="mt-3 space-y-2 text-sm">
              <li><a class="hover:underline" href="/help">Help</a></li>
              <li><a class="hover:underline" href="/contact">Contacts</a></li>
              <li><a class="hover:underline" href="/terms-and-conditions">Terms & Conditions</a></li>
              <li><a class="hover:underline" href="/privacy-policy">Privacy Policy</a></li>
            </ul>
          </section>
        </div>
        <div class="mx-auto w-full max-w-6xl border-t px-5 py-4 text-sm text-muted-foreground">
          <p>&copy; {new Date().getFullYear()} Telecommut. All rights reserved.</p>
        </div>
      </footer>
    </div>
  </body>
</html>
